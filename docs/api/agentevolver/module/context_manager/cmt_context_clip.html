<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>agentevolver.module.context_manager.cmt_context_clip API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../context_manager.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;agentevolver.module.context_manager</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#construct_alien_llm_chat_fn">construct_alien_llm_chat_fn</a>
            </li>
            <li>
                    <a class="class" href="#SelfContextClipCMT">SelfContextClipCMT</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SelfContextClipCMT.__init__">SelfContextClipCMT</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.llm_chat_fn">llm_chat_fn</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.alien_llm_chat_fn">alien_llm_chat_fn</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.latest_env_response_id">latest_env_response_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.latest_env_response_content">latest_env_response_content</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.console_debug_mode">console_debug_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.force_think">force_think</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.env_feedin_preference">env_feedin_preference</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.train_sp_action">train_sp_action</a>
                        </li>
                        <li>
                                <a class="variable" href="#SelfContextClipCMT.clipped_before">clipped_before</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.post_tag_init_message_context">post_tag_init_message_context</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.post_tag_env_message_context">post_tag_env_message_context</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.post_tag_llm_message_context">post_tag_llm_message_context</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.strip_think_tags">strip_think_tags</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.prepare_next_llm_context">prepare_next_llm_context</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.save_init_input">save_init_input</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.impl_new_request_from_previous_interaction">impl_new_request_from_previous_interaction</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.after_save_llm_output">after_save_llm_output</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.replace_full_context_item">replace_full_context_item</a>
                        </li>
                        <li>
                                <a class="function" href="#SelfContextClipCMT.save_llm_output">save_llm_output</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../agentevolver.html">agentevolver</a><wbr>.<a href="./../../module.html">module</a><wbr>.<a href="./../context_manager.html">context_manager</a><wbr>.cmt_context_clip    </h1>

                
                        <input id="mod-cmt_context_clip-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-cmt_context_clip-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">agentevolver.schema.trajectory</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sample</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">best_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_dict</span><span class="p">,</span> <span class="n">print_listofdict</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">agentevolver.module.context_manager.cmt_linear_think</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExtendedMessage</span><span class="p">,</span> <span class="n">Linear_CMT</span><span class="p">,</span> <span class="n">LinearThinkCMT</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">agentevolver.module.context_manager.cmt_linear</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_sublist_indices</span><span class="p">,</span> <span class="n">replace_token_ids</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">best_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_logger</span><span class="p">,</span> <span class="n">print_dict</span><span class="p">,</span> <span class="n">print_nested</span><span class="p">,</span> <span class="n">NestedJsonItem</span><span class="p">,</span> <span class="n">SeqItem</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="k">def</span><span class="w"> </span><span class="nf">construct_alien_llm_chat_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">rollout_config</span><span class="p">):</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">alien_llm_chat_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>        <span class="n">max_try</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>        <span class="n">alien_model_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_alien_llm_model</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>        <span class="n">alien_model_response_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_alien_model_response_length</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="n">regular_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">,</span> <span class="s2">&quot;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">]</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="n">backup_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">]</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>        <span class="k">for</span> <span class="n">n_try</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_try</span><span class="p">):</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>                <span class="k">if</span> <span class="n">n_try</span> <span class="o">&lt;</span> <span class="n">max_try</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">regular_key_list</span><span class="p">)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>                <span class="k">elif</span> <span class="n">n_try</span> <span class="o">==</span> <span class="n">max_try</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">backup_key_list</span><span class="p">)</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">regular_key_list</span> <span class="o">+</span> <span class="n">backup_key_list</span><span class="p">)</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>                <span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>                    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>                <span class="p">)</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>                <span class="n">sampling_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>                    <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>                    <span class="n">max_completion_tokens</span><span class="o">=</span><span class="n">alien_model_response_length</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>                <span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>                <span class="n">sampling_params</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>                    <span class="n">model</span><span class="o">=</span><span class="n">alien_model_name</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>                    <span class="n">extra_body</span><span class="o">=</span><span class="n">sampling_params</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>                <span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>                <span class="n">message</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>                <span class="k">if</span> <span class="s2">&quot;content&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling alien llm: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling alien llm: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, retrying...&quot;</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get response from alien llm after </span><span class="si">{</span><span class="n">max_try</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="k">return</span> <span class="n">alien_llm_chat_fn</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SelfContextClipCMT</span><span class="p">(</span><span class="n">LinearThinkCMT</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    A non-linear context manager template that handles the conversation flow between LLM and environment.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">llm_chat_fn</span><span class="p">):</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_chat_fn</span> <span class="o">=</span> <span class="n">llm_chat_fn</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alien_llm_chat_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">construct_alien_llm_chat_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console_debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">force_think</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">env_service</span><span class="o">.</span><span class="n">env_feedin_preference</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_train_sp_action</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="s2">                Additional requirements: Think before action! You must think step by step before your next action, and you must use &lt;think&gt;...&lt;/think&gt; to wrap your thinking process before finally produce your answer with </span><span class="se">\\</span><span class="s2">box</span><span class="si">{}</span><span class="s2">.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="s2">                Your thought (&lt;think&gt;...&lt;/think&gt;) should be as short and concise as possible.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="s2">                For example:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="s2">                &lt;think&gt;...your thinking process...&lt;/think&gt;</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="s2">                </span><span class="se">\\</span><span class="s2">box{...your final answer...}</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="s2">                Additional requirements: Think before action! You must think step by step before your next action, and you must use &lt;think&gt;...&lt;/think&gt; to wrap your thinking process before finally produce the next-step action.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="s2">                Your thought (&lt;think&gt;...&lt;/think&gt;) should be as short and concise as possible.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="s2">                For example:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="s2">                &lt;think&gt;...your thinking process...&lt;/think&gt;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="s2">                ```python</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="s2">                # your action here</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="s2">                ```</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_init_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        Processes the content of a message, ensuring it is properly formatted and adding additional prompts if necessary.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        Args:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">            content (str): The content of the message to be processed.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">            is_last (bool): A flag indicating whether this is the last message in the sequence.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        Returns:</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">            str: The processed content of the message.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="k">if</span> <span class="n">is_last</span><span class="p">:</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Ensure the content is stripped of leading/trailing whitespace</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="k">if</span> <span class="n">is_last</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span><span class="p">:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span>  <span class="c1">#  Append the force_think_prompt if this is the last message and force_think is enabled</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Return the final processed content</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_env_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        Formats and tags a message from the environment, appending an identifier based on the turn number.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        Updates the internal state with the latest environment response and its ID.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        If the message is the last and `force_think` is enabled, appends a prompt for further thinking.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        Args:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">            content (str): The content of the message from the environment.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">            turn (int): The turn number of the message, must be in the range [0, 99).</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">            is_last (bool): A flag indicating if this is the last message in the conversation.</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        Returns:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">            str: The formatted and tagged message content.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;turn must be in the range [0, 99)&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="n">turn_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">turn</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ER</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1">#  Update the latest environment response ID</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Update the latest environment response content</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="s2">            [Environment Response, id=ER</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">]</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="s2">            ---</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Format and tag the message content</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">is_last</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span>  <span class="c1">#  Append the force think prompt if necessary</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="k">return</span> <span class="n">content</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_llm_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        Formats the LLM&#39;s message by adding a specific tag and turn identifier.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        Args:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">            content (str): The content of the LLM&#39;s message.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">            turn (int): The turn number of the message in the conversation.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">            is_last (bool): A flag indicating if this is the last message in the conversation.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        Returns:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            str: The formatted message with the added tag and turn identifier.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">is_last</span><span class="p">,</span> <span class="s2">&quot;llm message should never be last&quot;</span>  <span class="c1">#  Ensures the LLM&#39;s message is not the last in the conversation</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;turn must be in the range [0, 99)&quot;</span>  <span class="c1">#  Validates the turn number is within the valid range</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">turn_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">turn</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="s2">            [Assistant Response, id=AR</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="s2">            ---</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Adds the tag and turn identifier to the message</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="k">return</span> <span class="n">content</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">strip_think_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">        Removes &lt;think&gt; and &lt;/think&gt; tags, along with their enclosed content, from the provided text.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        Args:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">            text (str): The input text containing &lt;think&gt; and &lt;/think&gt; tags.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">        Returns:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">            str: The text with all &lt;think&gt; and &lt;/think&gt; tags and their enclosed content removed.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&lt;think\&gt;.*?\&lt;\/think\&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Remove content within &lt;think&gt; and &lt;/think&gt; tags</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">new_ext_msg_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove any remaining &lt;think&gt; tags</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">new_ext_msg_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove any remaining &lt;/think&gt; tags</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">return</span> <span class="n">new_ext_msg_content</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_next_llm_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        Prepares the next context for the LLM by filtering and processing the previous messages.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        This function filters out non-deprecated context, processes each message based on its author,</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        and formats the context appropriately for the next LLM interaction.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        Returns:</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">            list: A list of dictionaries representing the updated context.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="c1"># first we get all previous context (non-deprecated context)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="c1"># get `init_message -&gt; user -&gt; llm -&gt; user -&gt; llm`` or `init_message -&gt; llm -&gt; user -&gt; llm -&gt; user``</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_context_via_authors</span><span class="p">([</span><span class="s2">&quot;initialization&quot;</span><span class="p">,</span> <span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">])</span>  <span class="c1">#  Filter the context to include only relevant authors</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="n">env_turn</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">llm_turn</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="n">is_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="c1"># Process according to message type</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm&quot;</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                <span class="c1"># If it&#39;s a previous llm message, remove think tags</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_think_tags</span><span class="p">(</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                <span class="n">author_override</span> <span class="o">=</span> <span class="s2">&quot;llm(do_not_train)&quot;</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">author_override</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_llm_message_context</span><span class="p">(</span><span class="n">new_ext_msg_content</span><span class="p">,</span> <span class="n">turn</span><span class="o">=</span><span class="n">llm_turn</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                <span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                <span class="n">llm_turn</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="c1"># process env message</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="k">elif</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_env_message_context</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">,</span> <span class="n">turn</span><span class="o">=</span><span class="n">env_turn</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                <span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                <span class="n">env_turn</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="k">elif</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;initialization&quot;</span><span class="p">]:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_init_message_context</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown author </span><span class="si">{</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2"> in latest_llm_interaction_socket&quot;</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="n">listofdict_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_role_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)</span>  <span class="c1">#  Convert the processed context to a list of dictionaries</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="n">listofdict_context</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_init_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_input_arr</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_nothink</span><span class="p">):</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        Saves the initial input array by calling the parent class&#39;s method.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        Args:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">            init_input_arr (list): The initial input array to be saved.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">            add_nothink: Additional parameter passed to the parent method.</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_init_input</span><span class="p">(</span><span class="n">init_input_arr</span><span class="p">,</span> <span class="n">add_nothink</span><span class="p">)</span>  <span class="c1">#  Calls the parent class&#39;s method to save the initial input</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">return</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">impl_new_request_from_previous_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_message</span><span class="p">,</span>  <span class="n">this_interaction</span><span class="p">,</span> <span class="n">strip_think</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        Processes a new request in the context of previous interactions, optionally stripping &#39;think&#39; tags,</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        and generates a new LLM response based on the updated context.</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        Args:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">            new_message: The new message to be added to the interaction.</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">            this_interaction: The list of previous interactions.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">            strip_think (bool, optional): Whether to strip &#39;think&#39; tags from the messages. Defaults to False.</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">        Returns:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">            tuple: A tuple containing the updated interaction list and the LLM&#39;s output content.</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="n">strip_think</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">):</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm(do_not_train)&quot;</span> <span class="ow">or</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm&quot;</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                    <span class="n">latest_llm_interaction_socket_additional</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                        <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strip_think_tags</span><span class="p">(</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                        <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span> <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span> <span class="k">else</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                    <span class="p">)</span>  <span class="c1">#  Strips &#39;think&#39; tags from the message content</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                    <span class="k">continue</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_message</span><span class="p">]</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">dict_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_role_content</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="n">llm_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_chat_fn</span><span class="p">(</span><span class="n">dict_context</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1">#  Generates LLM output using the current model</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="n">llm_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alien_llm_chat_fn</span><span class="p">(</span><span class="n">dict_context</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1">#  Generates LLM output using an external model</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_llm_output_do_not_register_full_context</span><span class="p">(</span><span class="n">llm_output</span><span class="p">,</span> <span class="n">dict_context</span><span class="p">)]</span>  <span class="c1">#  Adds the LLM output to the interaction history</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grouped_steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">this_interaction</span><span class="p">]</span>  <span class="c1">#  Updates the grouped steps with the latest interaction</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console_debug_mode</span><span class="p">:</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="n">print_listofdict</span><span class="p">(</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                <span class="n">dict_context</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;llm_latest&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}],</span> <span class="n">mod</span><span class="o">=</span><span class="s1">&#39;c&#39;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="p">)</span>  <span class="c1">#  Prints the updated context and LLM output to the console</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            <span class="n">print_listofdict</span><span class="p">(</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                <span class="n">dict_context</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;llm_latest&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}],</span> <span class="n">mod</span><span class="o">=</span><span class="s1">&#39;env_clip&#39;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="p">)</span>  <span class="c1">#  Logs the updated context and LLM output to a file</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="n">output_llm_content</span> <span class="o">=</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="k">return</span> <span class="n">latest_llm_interaction_socket_additional</span><span class="p">,</span> <span class="n">output_llm_content</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">after_save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">this_interaction</span><span class="p">):</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        this_interaction = [</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">            init msg,</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">            ...,</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">            init msg,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">            ...</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">            previous env msg,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">            latest llm msg,</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        ]</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="k">return</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="n">clip_token_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_clip_trigger_token_num</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_seq_length</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">clip_token_cnt</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="k">return</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="k">return</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">generated_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl_new_request_from_previous_interaction</span><span class="p">(</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="n">new_message</span><span class="o">=</span><span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="s2">                    Your new task is to inspect each `Environment Response` and `Assistant Response` messages,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="s2">                    and determine whether each message is useful for the next-step decision-making.</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="s2">                    Generate a json structure following the format below:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="s2">                    ```json</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="s2">                    [</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="s2">                        {&quot;id&quot;:&quot;ARXXX or ERXXX&quot;, &quot;useful&quot;:true or false, &quot;action&quot;: &quot;keep or remove or compress&quot;},</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="s2">                        ...,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="s2">                        {&quot;id&quot;:&quot;ARXXX or ERXXX&quot;, &quot;useful&quot;:true or false, &quot;action&quot;: &quot;keep or remove or compress&quot;},</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="s2">                    ]</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="s2">                    ```</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="s2">                    For example:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="s2">                    ```json</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="s2">                    [</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="s2">                        {&quot;id&quot;:&quot;ER001&quot;, &quot;useful&quot;:true, &quot;action&quot;: &quot;keep&quot;},</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="s2">                        {&quot;id&quot;:&quot;AR001&quot;, &quot;useful&quot;:false, &quot;action&quot;: &quot;remove&quot;},</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="s2">                        ...</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="s2">                    ]</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="s2">                    ```</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="s2">                    Rules:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="s2">                    - If the message contains useful information for future decisions, set &quot;useful&quot;:true and &quot;action&quot;:&quot;keep&quot;.</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="s2">                    - If the message records important previous action or environment feedback, set &quot;useful&quot;:true and &quot;action&quot;:&quot;keep&quot;.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="s2">                    - If the message is very long and very redundant, set &quot;useful&quot;:true and &quot;action&quot;:&quot;compress&quot;.</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="s2">                    - If the message is completely irrelevant, set &quot;useful&quot;:false and &quot;action&quot;:&quot;remove&quot;. Note that important failures should be preserved, because learning from past is vital.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="s2">                    - Ignore messages without id=XXX tags, where XXX is a 3-digit number.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="s2">                    - Ensure the JSON is properly formatted and valid.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="s2">                    - Remove or compress at least one message, because token limit is already reached.</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="s2">                    - At least remove (or compress) one message.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="s2">                    - There must be no more than 2 &quot;compress&quot; actions in total, because &quot;compress&quot; action will cost considerable amount of time.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">),</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="p">),</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">this_interaction</span><span class="o">=</span><span class="n">this_interaction</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="n">strip_think</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="n">llm_output_content</span> <span class="o">=</span> <span class="n">generated_content</span> <span class="o">=</span> <span class="n">generated_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="n">llm_output_content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="n">extracted_content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">llm_output_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find ``` in llm_output content: </span><span class="si">{</span><span class="n">llm_output_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="k">if</span> <span class="n">extracted_content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                <span class="n">extracted_content</span> <span class="o">=</span> <span class="n">extracted_content</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="n">extracted_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">extracted_json</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="s1">&#39;useful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="s1">&#39;action&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each item must contain &#39;id&#39;, &#39;useful&#39;, and &#39;action&#39; fields. Error in item: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                <span class="n">message_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="n">message_action</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="c1"># find message from self.full_context</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="c1">## match latest_llm_interaction_socket_additional and match self.full_context</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                <span class="n">from_uuid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                <span class="k">for</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="n">this_interaction</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                    <span class="k">if</span> <span class="n">message_id</span> <span class="ow">in</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                        <span class="n">from_uuid</span> <span class="o">=</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                        <span class="k">break</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                <span class="k">if</span> <span class="n">from_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find message_id </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> in `this_interaction`&quot;</span><span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="n">target_msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">target_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">):</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">from_uuid</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                        <span class="n">target_msg</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                        <span class="n">target_index</span> <span class="o">=</span> <span class="n">index</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="k">break</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                <span class="k">if</span> <span class="n">target_msg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find message_id </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> in full_context&quot;</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                <span class="c1">## take actions</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                <span class="k">if</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">author</span><span class="o">+</span><span class="s2">&quot;(discard)&quot;</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                        <span class="n">content</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># keep original content</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                    <span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="k">elif</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;compress&#39;</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">message_id</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">generated_compressed_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl_new_request_from_previous_interaction</span><span class="p">(</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                        <span class="n">new_message</span><span class="o">=</span><span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                            <span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                            <span class="n">content</span><span class="o">=</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="s2">                                Your new task is to inspect </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">, and filter out all redundant information, and only keep the most important information that is useful for future decision-making.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="s2">                                For example, if the content is a long text with multiple paragraphs, you should only preseve the key paragraphs and use ... to replace the rest.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="s2">                                If the content is a long list of data / dict / json, you should only preseve the key items and use ... to replace the rest.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="s2">                                Be careful to preserve all information that might be useful in the future. You should at least reduce 50% of </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="s2">                                Remember wrap your answer with ```</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="s2">                                Your response should be like:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="s2">                                ```</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="s2">                                ...content after filtering...</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="s2">                                ```</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="s2">                            &quot;&quot;&quot;</span><span class="p">),</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                            <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                        <span class="p">),</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                        <span class="n">this_interaction</span><span class="o">=</span><span class="n">this_interaction</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># exclude the latest llm message</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                        <span class="n">strip_think</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                    <span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                    <span class="k">if</span> <span class="n">generated_compressed_content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find ``` in llm_output content: </span><span class="si">{</span><span class="n">generated_compressed_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                    <span class="n">compressed_content</span> <span class="o">=</span> <span class="n">generated_compressed_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                        <span class="n">content</span><span class="o">=</span><span class="n">compressed_content</span><span class="p">,</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                    <span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                <span class="k">elif</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;keep&#39;</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                    <span class="k">continue</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action </span><span class="si">{</span><span class="n">message_action</span><span class="si">}</span><span class="s2">, must be one of [&#39;remove&#39;, &#39;keep&#39;, &#39;compress&#39;]&quot;</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing llm_output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing llm_output&quot;</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="k">return</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">replace_full_context_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        Replaces the content of a message in the full context with new content if the match content is found.</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">        Args:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">            match_content (str): The content to search for in the full context.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">            new_content (str): The new content to replace the matched content with.</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">        Returns:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">            bool: True if the replacement was successful, False otherwise.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">)):</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="n">ext_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="k">if</span> <span class="n">match_content</span> <span class="ow">in</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                    <span class="n">content</span><span class="o">=</span><span class="n">new_content</span><span class="p">,</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="p">)</span>  <span class="c1">#  Replace the matched content with the new content</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                <span class="c1"># print_dict({match_content: new_content})</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="k">return</span> <span class="n">success</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="k">return</span> <span class="n">success</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">input_msg_ref</span><span class="p">):</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        Saves the LLM&#39;s output, updates the grouped steps with the latest interaction, and resets the latest LLM interaction socket.</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">        Args:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">            llm_output (str): The output generated by the LLM.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">            input_msg_ref (str): The reference to the input message that triggered the LLM&#39;s response.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a><span class="sd">        Returns:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">            None</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="n">ext_msg</span> <span class="o">=</span> <span class="n">Linear_CMT</span><span class="o">.</span><span class="n">save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">input_msg_ref</span><span class="p">)</span>  <span class="c1">#  Save the LLM output and get the extended message</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">+</span> <span class="p">[</span><span class="n">ext_msg</span><span class="p">])</span>  <span class="c1">#  Create a deep copy of the latest interaction including the new message</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grouped_steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">this_interaction</span><span class="p">]</span>  <span class="c1">#  Append the new interaction to the grouped steps</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">after_save_llm_output</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>  <span class="c1">#  Call the after-save hook for any additional processing</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#  Reset the latest LLM interaction socket</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="k">return</span>
</span></pre></div>


            </section>
                <section id="construct_alien_llm_chat_fn">
                            <input id="construct_alien_llm_chat_fn-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">construct_alien_llm_chat_fn</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config</span>, </span><span class="param"><span class="n">rollout_config</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="construct_alien_llm_chat_fn-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#construct_alien_llm_chat_fn"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="construct_alien_llm_chat_fn-19"><a href="#construct_alien_llm_chat_fn-19"><span class="linenos">19</span></a><span class="k">def</span><span class="w"> </span><span class="nf">construct_alien_llm_chat_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">rollout_config</span><span class="p">):</span>
</span><span id="construct_alien_llm_chat_fn-20"><a href="#construct_alien_llm_chat_fn-20"><span class="linenos">20</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">alien_llm_chat_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="construct_alien_llm_chat_fn-21"><a href="#construct_alien_llm_chat_fn-21"><span class="linenos">21</span></a>        <span class="n">max_try</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="construct_alien_llm_chat_fn-22"><a href="#construct_alien_llm_chat_fn-22"><span class="linenos">22</span></a>        <span class="n">alien_model_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_alien_llm_model</span>
</span><span id="construct_alien_llm_chat_fn-23"><a href="#construct_alien_llm_chat_fn-23"><span class="linenos">23</span></a>        <span class="n">alien_model_response_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_alien_model_response_length</span>
</span><span id="construct_alien_llm_chat_fn-24"><a href="#construct_alien_llm_chat_fn-24"><span class="linenos">24</span></a>        <span class="n">regular_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">,</span> <span class="s2">&quot;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">]</span>
</span><span id="construct_alien_llm_chat_fn-25"><a href="#construct_alien_llm_chat_fn-25"><span class="linenos">25</span></a>        <span class="n">backup_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">]</span>
</span><span id="construct_alien_llm_chat_fn-26"><a href="#construct_alien_llm_chat_fn-26"><span class="linenos">26</span></a>        <span class="k">for</span> <span class="n">n_try</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_try</span><span class="p">):</span>
</span><span id="construct_alien_llm_chat_fn-27"><a href="#construct_alien_llm_chat_fn-27"><span class="linenos">27</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="construct_alien_llm_chat_fn-28"><a href="#construct_alien_llm_chat_fn-28"><span class="linenos">28</span></a>                <span class="k">if</span> <span class="n">n_try</span> <span class="o">&lt;</span> <span class="n">max_try</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="construct_alien_llm_chat_fn-29"><a href="#construct_alien_llm_chat_fn-29"><span class="linenos">29</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">regular_key_list</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-30"><a href="#construct_alien_llm_chat_fn-30"><span class="linenos">30</span></a>                <span class="k">elif</span> <span class="n">n_try</span> <span class="o">==</span> <span class="n">max_try</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="construct_alien_llm_chat_fn-31"><a href="#construct_alien_llm_chat_fn-31"><span class="linenos">31</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">backup_key_list</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-32"><a href="#construct_alien_llm_chat_fn-32"><span class="linenos">32</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="construct_alien_llm_chat_fn-33"><a href="#construct_alien_llm_chat_fn-33"><span class="linenos">33</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">regular_key_list</span> <span class="o">+</span> <span class="n">backup_key_list</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-34"><a href="#construct_alien_llm_chat_fn-34"><span class="linenos">34</span></a>                <span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
</span><span id="construct_alien_llm_chat_fn-35"><a href="#construct_alien_llm_chat_fn-35"><span class="linenos">35</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
</span><span id="construct_alien_llm_chat_fn-36"><a href="#construct_alien_llm_chat_fn-36"><span class="linenos">36</span></a>                    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><span class="p">,</span>
</span><span id="construct_alien_llm_chat_fn-37"><a href="#construct_alien_llm_chat_fn-37"><span class="linenos">37</span></a>                <span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-38"><a href="#construct_alien_llm_chat_fn-38"><span class="linenos">38</span></a>                <span class="n">sampling_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="construct_alien_llm_chat_fn-39"><a href="#construct_alien_llm_chat_fn-39"><span class="linenos">39</span></a>                    <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="construct_alien_llm_chat_fn-40"><a href="#construct_alien_llm_chat_fn-40"><span class="linenos">40</span></a>                    <span class="n">max_completion_tokens</span><span class="o">=</span><span class="n">alien_model_response_length</span><span class="p">,</span>
</span><span id="construct_alien_llm_chat_fn-41"><a href="#construct_alien_llm_chat_fn-41"><span class="linenos">41</span></a>                <span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-42"><a href="#construct_alien_llm_chat_fn-42"><span class="linenos">42</span></a>                <span class="n">sampling_params</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="construct_alien_llm_chat_fn-43"><a href="#construct_alien_llm_chat_fn-43"><span class="linenos">43</span></a>                <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="construct_alien_llm_chat_fn-44"><a href="#construct_alien_llm_chat_fn-44"><span class="linenos">44</span></a>                    <span class="n">model</span><span class="o">=</span><span class="n">alien_model_name</span><span class="p">,</span>
</span><span id="construct_alien_llm_chat_fn-45"><a href="#construct_alien_llm_chat_fn-45"><span class="linenos">45</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="construct_alien_llm_chat_fn-46"><a href="#construct_alien_llm_chat_fn-46"><span class="linenos">46</span></a>                    <span class="n">extra_body</span><span class="o">=</span><span class="n">sampling_params</span>
</span><span id="construct_alien_llm_chat_fn-47"><a href="#construct_alien_llm_chat_fn-47"><span class="linenos">47</span></a>                <span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-48"><a href="#construct_alien_llm_chat_fn-48"><span class="linenos">48</span></a>                <span class="n">message</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-49"><a href="#construct_alien_llm_chat_fn-49"><span class="linenos">49</span></a>                <span class="k">if</span> <span class="s2">&quot;content&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="construct_alien_llm_chat_fn-50"><a href="#construct_alien_llm_chat_fn-50"><span class="linenos">50</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}</span>
</span><span id="construct_alien_llm_chat_fn-51"><a href="#construct_alien_llm_chat_fn-51"><span class="linenos">51</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="construct_alien_llm_chat_fn-52"><a href="#construct_alien_llm_chat_fn-52"><span class="linenos">52</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling alien llm: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-53"><a href="#construct_alien_llm_chat_fn-53"><span class="linenos">53</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-54"><a href="#construct_alien_llm_chat_fn-54"><span class="linenos">54</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling alien llm: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, retrying...&quot;</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-55"><a href="#construct_alien_llm_chat_fn-55"><span class="linenos">55</span></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get response from alien llm after </span><span class="si">{</span><span class="n">max_try</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span>
</span><span id="construct_alien_llm_chat_fn-56"><a href="#construct_alien_llm_chat_fn-56"><span class="linenos">56</span></a>    <span class="k">return</span> <span class="n">alien_llm_chat_fn</span>
</span></pre></div>


    

                </section>
                <section id="SelfContextClipCMT">
                            <input id="SelfContextClipCMT-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SelfContextClipCMT</span><wbr>(<span class="base"><a href="cmt_linear_think.html#LinearThinkCMT">agentevolver.module.context_manager.cmt_linear_think.LinearThinkCMT</a></span>):

                <label class="view-source-button" for="SelfContextClipCMT-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT-59"><a href="#SelfContextClipCMT-59"><span class="linenos"> 59</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SelfContextClipCMT</span><span class="p">(</span><span class="n">LinearThinkCMT</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-60"><a href="#SelfContextClipCMT-60"><span class="linenos"> 60</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-61"><a href="#SelfContextClipCMT-61"><span class="linenos"> 61</span></a><span class="sd">    A non-linear context manager template that handles the conversation flow between LLM and environment.</span>
</span><span id="SelfContextClipCMT-62"><a href="#SelfContextClipCMT-62"><span class="linenos"> 62</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-63"><a href="#SelfContextClipCMT-63"><span class="linenos"> 63</span></a>
</span><span id="SelfContextClipCMT-64"><a href="#SelfContextClipCMT-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">llm_chat_fn</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-65"><a href="#SelfContextClipCMT-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_chat_fn</span> <span class="o">=</span> <span class="n">llm_chat_fn</span>
</span><span id="SelfContextClipCMT-66"><a href="#SelfContextClipCMT-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alien_llm_chat_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">construct_alien_llm_chat_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-67"><a href="#SelfContextClipCMT-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="SelfContextClipCMT-68"><a href="#SelfContextClipCMT-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="SelfContextClipCMT-69"><a href="#SelfContextClipCMT-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console_debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SelfContextClipCMT-70"><a href="#SelfContextClipCMT-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">force_think</span>
</span><span id="SelfContextClipCMT-71"><a href="#SelfContextClipCMT-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">env_service</span><span class="o">.</span><span class="n">env_feedin_preference</span>
</span><span id="SelfContextClipCMT-72"><a href="#SelfContextClipCMT-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_train_sp_action</span>
</span><span id="SelfContextClipCMT-73"><a href="#SelfContextClipCMT-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SelfContextClipCMT-74"><a href="#SelfContextClipCMT-74"><span class="linenos"> 74</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-75"><a href="#SelfContextClipCMT-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-76"><a href="#SelfContextClipCMT-76"><span class="linenos"> 76</span></a><span class="s2">                Additional requirements: Think before action! You must think step by step before your next action, and you must use &lt;think&gt;...&lt;/think&gt; to wrap your thinking process before finally produce your answer with </span><span class="se">\\</span><span class="s2">box</span><span class="si">{}</span><span class="s2">.</span>
</span><span id="SelfContextClipCMT-77"><a href="#SelfContextClipCMT-77"><span class="linenos"> 77</span></a><span class="s2">                Your thought (&lt;think&gt;...&lt;/think&gt;) should be as short and concise as possible.</span>
</span><span id="SelfContextClipCMT-78"><a href="#SelfContextClipCMT-78"><span class="linenos"> 78</span></a><span class="s2">                For example:</span>
</span><span id="SelfContextClipCMT-79"><a href="#SelfContextClipCMT-79"><span class="linenos"> 79</span></a><span class="s2">                &lt;think&gt;...your thinking process...&lt;/think&gt;</span>
</span><span id="SelfContextClipCMT-80"><a href="#SelfContextClipCMT-80"><span class="linenos"> 80</span></a><span class="s2">                </span><span class="se">\\</span><span class="s2">box{...your final answer...}</span>
</span><span id="SelfContextClipCMT-81"><a href="#SelfContextClipCMT-81"><span class="linenos"> 81</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-82"><a href="#SelfContextClipCMT-82"><span class="linenos"> 82</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-83"><a href="#SelfContextClipCMT-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-84"><a href="#SelfContextClipCMT-84"><span class="linenos"> 84</span></a><span class="s2">                Additional requirements: Think before action! You must think step by step before your next action, and you must use &lt;think&gt;...&lt;/think&gt; to wrap your thinking process before finally produce the next-step action.</span>
</span><span id="SelfContextClipCMT-85"><a href="#SelfContextClipCMT-85"><span class="linenos"> 85</span></a><span class="s2">                Your thought (&lt;think&gt;...&lt;/think&gt;) should be as short and concise as possible.</span>
</span><span id="SelfContextClipCMT-86"><a href="#SelfContextClipCMT-86"><span class="linenos"> 86</span></a><span class="s2">                For example:</span>
</span><span id="SelfContextClipCMT-87"><a href="#SelfContextClipCMT-87"><span class="linenos"> 87</span></a><span class="s2">                &lt;think&gt;...your thinking process...&lt;/think&gt;</span>
</span><span id="SelfContextClipCMT-88"><a href="#SelfContextClipCMT-88"><span class="linenos"> 88</span></a><span class="s2">                ```python</span>
</span><span id="SelfContextClipCMT-89"><a href="#SelfContextClipCMT-89"><span class="linenos"> 89</span></a><span class="s2">                # your action here</span>
</span><span id="SelfContextClipCMT-90"><a href="#SelfContextClipCMT-90"><span class="linenos"> 90</span></a><span class="s2">                ```</span>
</span><span id="SelfContextClipCMT-91"><a href="#SelfContextClipCMT-91"><span class="linenos"> 91</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-92"><a href="#SelfContextClipCMT-92"><span class="linenos"> 92</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-93"><a href="#SelfContextClipCMT-93"><span class="linenos"> 93</span></a>
</span><span id="SelfContextClipCMT-94"><a href="#SelfContextClipCMT-94"><span class="linenos"> 94</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_init_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-95"><a href="#SelfContextClipCMT-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-96"><a href="#SelfContextClipCMT-96"><span class="linenos"> 96</span></a><span class="sd">        Processes the content of a message, ensuring it is properly formatted and adding additional prompts if necessary.</span>
</span><span id="SelfContextClipCMT-97"><a href="#SelfContextClipCMT-97"><span class="linenos"> 97</span></a>
</span><span id="SelfContextClipCMT-98"><a href="#SelfContextClipCMT-98"><span class="linenos"> 98</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-99"><a href="#SelfContextClipCMT-99"><span class="linenos"> 99</span></a><span class="sd">            content (str): The content of the message to be processed.</span>
</span><span id="SelfContextClipCMT-100"><a href="#SelfContextClipCMT-100"><span class="linenos">100</span></a><span class="sd">            is_last (bool): A flag indicating whether this is the last message in the sequence.</span>
</span><span id="SelfContextClipCMT-101"><a href="#SelfContextClipCMT-101"><span class="linenos">101</span></a>
</span><span id="SelfContextClipCMT-102"><a href="#SelfContextClipCMT-102"><span class="linenos">102</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-103"><a href="#SelfContextClipCMT-103"><span class="linenos">103</span></a><span class="sd">            str: The processed content of the message.</span>
</span><span id="SelfContextClipCMT-104"><a href="#SelfContextClipCMT-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-105"><a href="#SelfContextClipCMT-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="n">is_last</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-106"><a href="#SelfContextClipCMT-106"><span class="linenos">106</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Ensure the content is stripped of leading/trailing whitespace</span>
</span><span id="SelfContextClipCMT-107"><a href="#SelfContextClipCMT-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="n">is_last</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-108"><a href="#SelfContextClipCMT-108"><span class="linenos">108</span></a>            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span>  <span class="c1">#  Append the force_think_prompt if this is the last message and force_think is enabled</span>
</span><span id="SelfContextClipCMT-109"><a href="#SelfContextClipCMT-109"><span class="linenos">109</span></a>        <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Return the final processed content</span>
</span><span id="SelfContextClipCMT-110"><a href="#SelfContextClipCMT-110"><span class="linenos">110</span></a>
</span><span id="SelfContextClipCMT-111"><a href="#SelfContextClipCMT-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_env_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-112"><a href="#SelfContextClipCMT-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-113"><a href="#SelfContextClipCMT-113"><span class="linenos">113</span></a><span class="sd">        Formats and tags a message from the environment, appending an identifier based on the turn number.</span>
</span><span id="SelfContextClipCMT-114"><a href="#SelfContextClipCMT-114"><span class="linenos">114</span></a><span class="sd">        Updates the internal state with the latest environment response and its ID.</span>
</span><span id="SelfContextClipCMT-115"><a href="#SelfContextClipCMT-115"><span class="linenos">115</span></a><span class="sd">        If the message is the last and `force_think` is enabled, appends a prompt for further thinking.</span>
</span><span id="SelfContextClipCMT-116"><a href="#SelfContextClipCMT-116"><span class="linenos">116</span></a>
</span><span id="SelfContextClipCMT-117"><a href="#SelfContextClipCMT-117"><span class="linenos">117</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-118"><a href="#SelfContextClipCMT-118"><span class="linenos">118</span></a><span class="sd">            content (str): The content of the message from the environment.</span>
</span><span id="SelfContextClipCMT-119"><a href="#SelfContextClipCMT-119"><span class="linenos">119</span></a><span class="sd">            turn (int): The turn number of the message, must be in the range [0, 99).</span>
</span><span id="SelfContextClipCMT-120"><a href="#SelfContextClipCMT-120"><span class="linenos">120</span></a><span class="sd">            is_last (bool): A flag indicating if this is the last message in the conversation.</span>
</span><span id="SelfContextClipCMT-121"><a href="#SelfContextClipCMT-121"><span class="linenos">121</span></a>
</span><span id="SelfContextClipCMT-122"><a href="#SelfContextClipCMT-122"><span class="linenos">122</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-123"><a href="#SelfContextClipCMT-123"><span class="linenos">123</span></a><span class="sd">            str: The formatted and tagged message content.</span>
</span><span id="SelfContextClipCMT-124"><a href="#SelfContextClipCMT-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-125"><a href="#SelfContextClipCMT-125"><span class="linenos">125</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="SelfContextClipCMT-126"><a href="#SelfContextClipCMT-126"><span class="linenos">126</span></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;turn must be in the range [0, 99)&quot;</span>
</span><span id="SelfContextClipCMT-127"><a href="#SelfContextClipCMT-127"><span class="linenos">127</span></a>        <span class="n">turn_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">turn</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SelfContextClipCMT-128"><a href="#SelfContextClipCMT-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ER</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1">#  Update the latest environment response ID</span>
</span><span id="SelfContextClipCMT-129"><a href="#SelfContextClipCMT-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Update the latest environment response content</span>
</span><span id="SelfContextClipCMT-130"><a href="#SelfContextClipCMT-130"><span class="linenos">130</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-131"><a href="#SelfContextClipCMT-131"><span class="linenos">131</span></a><span class="s2">            [Environment Response, id=ER</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">]</span>
</span><span id="SelfContextClipCMT-132"><a href="#SelfContextClipCMT-132"><span class="linenos">132</span></a><span class="s2">            ---</span>
</span><span id="SelfContextClipCMT-133"><a href="#SelfContextClipCMT-133"><span class="linenos">133</span></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Format and tag the message content</span>
</span><span id="SelfContextClipCMT-134"><a href="#SelfContextClipCMT-134"><span class="linenos">134</span></a>        <span class="k">if</span> <span class="n">is_last</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-135"><a href="#SelfContextClipCMT-135"><span class="linenos">135</span></a>            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span>  <span class="c1">#  Append the force think prompt if necessary</span>
</span><span id="SelfContextClipCMT-136"><a href="#SelfContextClipCMT-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="n">content</span>
</span><span id="SelfContextClipCMT-137"><a href="#SelfContextClipCMT-137"><span class="linenos">137</span></a>
</span><span id="SelfContextClipCMT-138"><a href="#SelfContextClipCMT-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_llm_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-139"><a href="#SelfContextClipCMT-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-140"><a href="#SelfContextClipCMT-140"><span class="linenos">140</span></a><span class="sd">        Formats the LLM&#39;s message by adding a specific tag and turn identifier.</span>
</span><span id="SelfContextClipCMT-141"><a href="#SelfContextClipCMT-141"><span class="linenos">141</span></a>
</span><span id="SelfContextClipCMT-142"><a href="#SelfContextClipCMT-142"><span class="linenos">142</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-143"><a href="#SelfContextClipCMT-143"><span class="linenos">143</span></a><span class="sd">            content (str): The content of the LLM&#39;s message.</span>
</span><span id="SelfContextClipCMT-144"><a href="#SelfContextClipCMT-144"><span class="linenos">144</span></a><span class="sd">            turn (int): The turn number of the message in the conversation.</span>
</span><span id="SelfContextClipCMT-145"><a href="#SelfContextClipCMT-145"><span class="linenos">145</span></a><span class="sd">            is_last (bool): A flag indicating if this is the last message in the conversation.</span>
</span><span id="SelfContextClipCMT-146"><a href="#SelfContextClipCMT-146"><span class="linenos">146</span></a>
</span><span id="SelfContextClipCMT-147"><a href="#SelfContextClipCMT-147"><span class="linenos">147</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-148"><a href="#SelfContextClipCMT-148"><span class="linenos">148</span></a><span class="sd">            str: The formatted message with the added tag and turn identifier.</span>
</span><span id="SelfContextClipCMT-149"><a href="#SelfContextClipCMT-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-150"><a href="#SelfContextClipCMT-150"><span class="linenos">150</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="SelfContextClipCMT-151"><a href="#SelfContextClipCMT-151"><span class="linenos">151</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">is_last</span><span class="p">,</span> <span class="s2">&quot;llm message should never be last&quot;</span>  <span class="c1">#  Ensures the LLM&#39;s message is not the last in the conversation</span>
</span><span id="SelfContextClipCMT-152"><a href="#SelfContextClipCMT-152"><span class="linenos">152</span></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;turn must be in the range [0, 99)&quot;</span>  <span class="c1">#  Validates the turn number is within the valid range</span>
</span><span id="SelfContextClipCMT-153"><a href="#SelfContextClipCMT-153"><span class="linenos">153</span></a>        <span class="n">turn_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">turn</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SelfContextClipCMT-154"><a href="#SelfContextClipCMT-154"><span class="linenos">154</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-155"><a href="#SelfContextClipCMT-155"><span class="linenos">155</span></a><span class="s2">            [Assistant Response, id=AR</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">]</span>
</span><span id="SelfContextClipCMT-156"><a href="#SelfContextClipCMT-156"><span class="linenos">156</span></a><span class="s2">            ---</span>
</span><span id="SelfContextClipCMT-157"><a href="#SelfContextClipCMT-157"><span class="linenos">157</span></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Adds the tag and turn identifier to the message</span>
</span><span id="SelfContextClipCMT-158"><a href="#SelfContextClipCMT-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="n">content</span>
</span><span id="SelfContextClipCMT-159"><a href="#SelfContextClipCMT-159"><span class="linenos">159</span></a>
</span><span id="SelfContextClipCMT-160"><a href="#SelfContextClipCMT-160"><span class="linenos">160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">strip_think_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-161"><a href="#SelfContextClipCMT-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-162"><a href="#SelfContextClipCMT-162"><span class="linenos">162</span></a><span class="sd">        Removes &lt;think&gt; and &lt;/think&gt; tags, along with their enclosed content, from the provided text.</span>
</span><span id="SelfContextClipCMT-163"><a href="#SelfContextClipCMT-163"><span class="linenos">163</span></a>
</span><span id="SelfContextClipCMT-164"><a href="#SelfContextClipCMT-164"><span class="linenos">164</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-165"><a href="#SelfContextClipCMT-165"><span class="linenos">165</span></a><span class="sd">            text (str): The input text containing &lt;think&gt; and &lt;/think&gt; tags.</span>
</span><span id="SelfContextClipCMT-166"><a href="#SelfContextClipCMT-166"><span class="linenos">166</span></a>
</span><span id="SelfContextClipCMT-167"><a href="#SelfContextClipCMT-167"><span class="linenos">167</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-168"><a href="#SelfContextClipCMT-168"><span class="linenos">168</span></a><span class="sd">            str: The text with all &lt;think&gt; and &lt;/think&gt; tags and their enclosed content removed.</span>
</span><span id="SelfContextClipCMT-169"><a href="#SelfContextClipCMT-169"><span class="linenos">169</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-170"><a href="#SelfContextClipCMT-170"><span class="linenos">170</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&lt;think\&gt;.*?\&lt;\/think\&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Remove content within &lt;think&gt; and &lt;/think&gt; tags</span>
</span><span id="SelfContextClipCMT-171"><a href="#SelfContextClipCMT-171"><span class="linenos">171</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">new_ext_msg_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove any remaining &lt;think&gt; tags</span>
</span><span id="SelfContextClipCMT-172"><a href="#SelfContextClipCMT-172"><span class="linenos">172</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">new_ext_msg_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove any remaining &lt;/think&gt; tags</span>
</span><span id="SelfContextClipCMT-173"><a href="#SelfContextClipCMT-173"><span class="linenos">173</span></a>        <span class="k">return</span> <span class="n">new_ext_msg_content</span>
</span><span id="SelfContextClipCMT-174"><a href="#SelfContextClipCMT-174"><span class="linenos">174</span></a>
</span><span id="SelfContextClipCMT-175"><a href="#SelfContextClipCMT-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_next_llm_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-176"><a href="#SelfContextClipCMT-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-177"><a href="#SelfContextClipCMT-177"><span class="linenos">177</span></a><span class="sd">        Prepares the next context for the LLM by filtering and processing the previous messages.</span>
</span><span id="SelfContextClipCMT-178"><a href="#SelfContextClipCMT-178"><span class="linenos">178</span></a>
</span><span id="SelfContextClipCMT-179"><a href="#SelfContextClipCMT-179"><span class="linenos">179</span></a><span class="sd">        This function filters out non-deprecated context, processes each message based on its author,</span>
</span><span id="SelfContextClipCMT-180"><a href="#SelfContextClipCMT-180"><span class="linenos">180</span></a><span class="sd">        and formats the context appropriately for the next LLM interaction.</span>
</span><span id="SelfContextClipCMT-181"><a href="#SelfContextClipCMT-181"><span class="linenos">181</span></a>
</span><span id="SelfContextClipCMT-182"><a href="#SelfContextClipCMT-182"><span class="linenos">182</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-183"><a href="#SelfContextClipCMT-183"><span class="linenos">183</span></a><span class="sd">            list: A list of dictionaries representing the updated context.</span>
</span><span id="SelfContextClipCMT-184"><a href="#SelfContextClipCMT-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-185"><a href="#SelfContextClipCMT-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SelfContextClipCMT-186"><a href="#SelfContextClipCMT-186"><span class="linenos">186</span></a>
</span><span id="SelfContextClipCMT-187"><a href="#SelfContextClipCMT-187"><span class="linenos">187</span></a>        <span class="c1"># first we get all previous context (non-deprecated context)</span>
</span><span id="SelfContextClipCMT-188"><a href="#SelfContextClipCMT-188"><span class="linenos">188</span></a>        <span class="c1"># get `init_message -&gt; user -&gt; llm -&gt; user -&gt; llm`` or `init_message -&gt; llm -&gt; user -&gt; llm -&gt; user``</span>
</span><span id="SelfContextClipCMT-189"><a href="#SelfContextClipCMT-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_context_via_authors</span><span class="p">([</span><span class="s2">&quot;initialization&quot;</span><span class="p">,</span> <span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">])</span>  <span class="c1">#  Filter the context to include only relevant authors</span>
</span><span id="SelfContextClipCMT-190"><a href="#SelfContextClipCMT-190"><span class="linenos">190</span></a>
</span><span id="SelfContextClipCMT-191"><a href="#SelfContextClipCMT-191"><span class="linenos">191</span></a>        <span class="n">env_turn</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT-192"><a href="#SelfContextClipCMT-192"><span class="linenos">192</span></a>        <span class="n">llm_turn</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT-193"><a href="#SelfContextClipCMT-193"><span class="linenos">193</span></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)):</span>
</span><span id="SelfContextClipCMT-194"><a href="#SelfContextClipCMT-194"><span class="linenos">194</span></a>            <span class="n">is_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-195"><a href="#SelfContextClipCMT-195"><span class="linenos">195</span></a>            <span class="c1"># Process according to message type</span>
</span><span id="SelfContextClipCMT-196"><a href="#SelfContextClipCMT-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-197"><a href="#SelfContextClipCMT-197"><span class="linenos">197</span></a>                <span class="c1"># If it&#39;s a previous llm message, remove think tags</span>
</span><span id="SelfContextClipCMT-198"><a href="#SelfContextClipCMT-198"><span class="linenos">198</span></a>                <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_think_tags</span><span class="p">(</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-199"><a href="#SelfContextClipCMT-199"><span class="linenos">199</span></a>                <span class="n">author_override</span> <span class="o">=</span> <span class="s2">&quot;llm(do_not_train)&quot;</span>
</span><span id="SelfContextClipCMT-200"><a href="#SelfContextClipCMT-200"><span class="linenos">200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-201"><a href="#SelfContextClipCMT-201"><span class="linenos">201</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">author_override</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-202"><a href="#SelfContextClipCMT-202"><span class="linenos">202</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-203"><a href="#SelfContextClipCMT-203"><span class="linenos">203</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_llm_message_context</span><span class="p">(</span><span class="n">new_ext_msg_content</span><span class="p">,</span> <span class="n">turn</span><span class="o">=</span><span class="n">llm_turn</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="SelfContextClipCMT-204"><a href="#SelfContextClipCMT-204"><span class="linenos">204</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-205"><a href="#SelfContextClipCMT-205"><span class="linenos">205</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-206"><a href="#SelfContextClipCMT-206"><span class="linenos">206</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-207"><a href="#SelfContextClipCMT-207"><span class="linenos">207</span></a>                <span class="p">)</span>
</span><span id="SelfContextClipCMT-208"><a href="#SelfContextClipCMT-208"><span class="linenos">208</span></a>                <span class="n">llm_turn</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT-209"><a href="#SelfContextClipCMT-209"><span class="linenos">209</span></a>
</span><span id="SelfContextClipCMT-210"><a href="#SelfContextClipCMT-210"><span class="linenos">210</span></a>            <span class="c1"># process env message</span>
</span><span id="SelfContextClipCMT-211"><a href="#SelfContextClipCMT-211"><span class="linenos">211</span></a>            <span class="k">elif</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-212"><a href="#SelfContextClipCMT-212"><span class="linenos">212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-213"><a href="#SelfContextClipCMT-213"><span class="linenos">213</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-214"><a href="#SelfContextClipCMT-214"><span class="linenos">214</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-215"><a href="#SelfContextClipCMT-215"><span class="linenos">215</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_env_message_context</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">,</span> <span class="n">turn</span><span class="o">=</span><span class="n">env_turn</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="SelfContextClipCMT-216"><a href="#SelfContextClipCMT-216"><span class="linenos">216</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-217"><a href="#SelfContextClipCMT-217"><span class="linenos">217</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-218"><a href="#SelfContextClipCMT-218"><span class="linenos">218</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-219"><a href="#SelfContextClipCMT-219"><span class="linenos">219</span></a>                <span class="p">)</span>
</span><span id="SelfContextClipCMT-220"><a href="#SelfContextClipCMT-220"><span class="linenos">220</span></a>                <span class="n">env_turn</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT-221"><a href="#SelfContextClipCMT-221"><span class="linenos">221</span></a>
</span><span id="SelfContextClipCMT-222"><a href="#SelfContextClipCMT-222"><span class="linenos">222</span></a>            <span class="k">elif</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;initialization&quot;</span><span class="p">]:</span>
</span><span id="SelfContextClipCMT-223"><a href="#SelfContextClipCMT-223"><span class="linenos">223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-224"><a href="#SelfContextClipCMT-224"><span class="linenos">224</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-225"><a href="#SelfContextClipCMT-225"><span class="linenos">225</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-226"><a href="#SelfContextClipCMT-226"><span class="linenos">226</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_init_message_context</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="SelfContextClipCMT-227"><a href="#SelfContextClipCMT-227"><span class="linenos">227</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-228"><a href="#SelfContextClipCMT-228"><span class="linenos">228</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-229"><a href="#SelfContextClipCMT-229"><span class="linenos">229</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-230"><a href="#SelfContextClipCMT-230"><span class="linenos">230</span></a>                <span class="p">)</span>
</span><span id="SelfContextClipCMT-231"><a href="#SelfContextClipCMT-231"><span class="linenos">231</span></a>
</span><span id="SelfContextClipCMT-232"><a href="#SelfContextClipCMT-232"><span class="linenos">232</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-233"><a href="#SelfContextClipCMT-233"><span class="linenos">233</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown author </span><span class="si">{</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2"> in latest_llm_interaction_socket&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-234"><a href="#SelfContextClipCMT-234"><span class="linenos">234</span></a>
</span><span id="SelfContextClipCMT-235"><a href="#SelfContextClipCMT-235"><span class="linenos">235</span></a>        <span class="n">listofdict_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_role_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)</span>  <span class="c1">#  Convert the processed context to a list of dictionaries</span>
</span><span id="SelfContextClipCMT-236"><a href="#SelfContextClipCMT-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">listofdict_context</span>
</span><span id="SelfContextClipCMT-237"><a href="#SelfContextClipCMT-237"><span class="linenos">237</span></a>
</span><span id="SelfContextClipCMT-238"><a href="#SelfContextClipCMT-238"><span class="linenos">238</span></a>
</span><span id="SelfContextClipCMT-239"><a href="#SelfContextClipCMT-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_init_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_input_arr</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_nothink</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-240"><a href="#SelfContextClipCMT-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-241"><a href="#SelfContextClipCMT-241"><span class="linenos">241</span></a><span class="sd">        Saves the initial input array by calling the parent class&#39;s method.</span>
</span><span id="SelfContextClipCMT-242"><a href="#SelfContextClipCMT-242"><span class="linenos">242</span></a>
</span><span id="SelfContextClipCMT-243"><a href="#SelfContextClipCMT-243"><span class="linenos">243</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-244"><a href="#SelfContextClipCMT-244"><span class="linenos">244</span></a><span class="sd">            init_input_arr (list): The initial input array to be saved.</span>
</span><span id="SelfContextClipCMT-245"><a href="#SelfContextClipCMT-245"><span class="linenos">245</span></a><span class="sd">            add_nothink: Additional parameter passed to the parent method.</span>
</span><span id="SelfContextClipCMT-246"><a href="#SelfContextClipCMT-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-247"><a href="#SelfContextClipCMT-247"><span class="linenos">247</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_init_input</span><span class="p">(</span><span class="n">init_input_arr</span><span class="p">,</span> <span class="n">add_nothink</span><span class="p">)</span>  <span class="c1">#  Calls the parent class&#39;s method to save the initial input</span>
</span><span id="SelfContextClipCMT-248"><a href="#SelfContextClipCMT-248"><span class="linenos">248</span></a>        <span class="k">return</span>
</span><span id="SelfContextClipCMT-249"><a href="#SelfContextClipCMT-249"><span class="linenos">249</span></a>
</span><span id="SelfContextClipCMT-250"><a href="#SelfContextClipCMT-250"><span class="linenos">250</span></a>
</span><span id="SelfContextClipCMT-251"><a href="#SelfContextClipCMT-251"><span class="linenos">251</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">impl_new_request_from_previous_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_message</span><span class="p">,</span>  <span class="n">this_interaction</span><span class="p">,</span> <span class="n">strip_think</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-252"><a href="#SelfContextClipCMT-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-253"><a href="#SelfContextClipCMT-253"><span class="linenos">253</span></a><span class="sd">        Processes a new request in the context of previous interactions, optionally stripping &#39;think&#39; tags,</span>
</span><span id="SelfContextClipCMT-254"><a href="#SelfContextClipCMT-254"><span class="linenos">254</span></a><span class="sd">        and generates a new LLM response based on the updated context.</span>
</span><span id="SelfContextClipCMT-255"><a href="#SelfContextClipCMT-255"><span class="linenos">255</span></a>
</span><span id="SelfContextClipCMT-256"><a href="#SelfContextClipCMT-256"><span class="linenos">256</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-257"><a href="#SelfContextClipCMT-257"><span class="linenos">257</span></a><span class="sd">            new_message: The new message to be added to the interaction.</span>
</span><span id="SelfContextClipCMT-258"><a href="#SelfContextClipCMT-258"><span class="linenos">258</span></a><span class="sd">            this_interaction: The list of previous interactions.</span>
</span><span id="SelfContextClipCMT-259"><a href="#SelfContextClipCMT-259"><span class="linenos">259</span></a><span class="sd">            strip_think (bool, optional): Whether to strip &#39;think&#39; tags from the messages. Defaults to False.</span>
</span><span id="SelfContextClipCMT-260"><a href="#SelfContextClipCMT-260"><span class="linenos">260</span></a>
</span><span id="SelfContextClipCMT-261"><a href="#SelfContextClipCMT-261"><span class="linenos">261</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-262"><a href="#SelfContextClipCMT-262"><span class="linenos">262</span></a><span class="sd">            tuple: A tuple containing the updated interaction list and the LLM&#39;s output content.</span>
</span><span id="SelfContextClipCMT-263"><a href="#SelfContextClipCMT-263"><span class="linenos">263</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-264"><a href="#SelfContextClipCMT-264"><span class="linenos">264</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-265"><a href="#SelfContextClipCMT-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">strip_think</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-266"><a href="#SelfContextClipCMT-266"><span class="linenos">266</span></a>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-267"><a href="#SelfContextClipCMT-267"><span class="linenos">267</span></a>                <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm(do_not_train)&quot;</span> <span class="ow">or</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-268"><a href="#SelfContextClipCMT-268"><span class="linenos">268</span></a>                    <span class="n">latest_llm_interaction_socket_additional</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-269"><a href="#SelfContextClipCMT-269"><span class="linenos">269</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-270"><a href="#SelfContextClipCMT-270"><span class="linenos">270</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-271"><a href="#SelfContextClipCMT-271"><span class="linenos">271</span></a>                        <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strip_think_tags</span><span class="p">(</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
</span><span id="SelfContextClipCMT-272"><a href="#SelfContextClipCMT-272"><span class="linenos">272</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-273"><a href="#SelfContextClipCMT-273"><span class="linenos">273</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-274"><a href="#SelfContextClipCMT-274"><span class="linenos">274</span></a>                        <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span> <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span> <span class="k">else</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-275"><a href="#SelfContextClipCMT-275"><span class="linenos">275</span></a>                    <span class="p">)</span>  <span class="c1">#  Strips &#39;think&#39; tags from the message content</span>
</span><span id="SelfContextClipCMT-276"><a href="#SelfContextClipCMT-276"><span class="linenos">276</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-277"><a href="#SelfContextClipCMT-277"><span class="linenos">277</span></a>                    <span class="k">continue</span>
</span><span id="SelfContextClipCMT-278"><a href="#SelfContextClipCMT-278"><span class="linenos">278</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_message</span><span class="p">]</span>
</span><span id="SelfContextClipCMT-279"><a href="#SelfContextClipCMT-279"><span class="linenos">279</span></a>        <span class="n">dict_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_role_content</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-280"><a href="#SelfContextClipCMT-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-281"><a href="#SelfContextClipCMT-281"><span class="linenos">281</span></a>            <span class="n">llm_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_chat_fn</span><span class="p">(</span><span class="n">dict_context</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1">#  Generates LLM output using the current model</span>
</span><span id="SelfContextClipCMT-282"><a href="#SelfContextClipCMT-282"><span class="linenos">282</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-283"><a href="#SelfContextClipCMT-283"><span class="linenos">283</span></a>            <span class="n">llm_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alien_llm_chat_fn</span><span class="p">(</span><span class="n">dict_context</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1">#  Generates LLM output using an external model</span>
</span><span id="SelfContextClipCMT-284"><a href="#SelfContextClipCMT-284"><span class="linenos">284</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_llm_output_do_not_register_full_context</span><span class="p">(</span><span class="n">llm_output</span><span class="p">,</span> <span class="n">dict_context</span><span class="p">)]</span>  <span class="c1">#  Adds the LLM output to the interaction history</span>
</span><span id="SelfContextClipCMT-285"><a href="#SelfContextClipCMT-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-286"><a href="#SelfContextClipCMT-286"><span class="linenos">286</span></a>            <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-287"><a href="#SelfContextClipCMT-287"><span class="linenos">287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grouped_steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">this_interaction</span><span class="p">]</span>  <span class="c1">#  Updates the grouped steps with the latest interaction</span>
</span><span id="SelfContextClipCMT-288"><a href="#SelfContextClipCMT-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console_debug_mode</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-289"><a href="#SelfContextClipCMT-289"><span class="linenos">289</span></a>            <span class="n">print_listofdict</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-290"><a href="#SelfContextClipCMT-290"><span class="linenos">290</span></a>                <span class="n">dict_context</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;llm_latest&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}],</span> <span class="n">mod</span><span class="o">=</span><span class="s1">&#39;c&#39;</span>
</span><span id="SelfContextClipCMT-291"><a href="#SelfContextClipCMT-291"><span class="linenos">291</span></a>            <span class="p">)</span>  <span class="c1">#  Prints the updated context and LLM output to the console</span>
</span><span id="SelfContextClipCMT-292"><a href="#SelfContextClipCMT-292"><span class="linenos">292</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-293"><a href="#SelfContextClipCMT-293"><span class="linenos">293</span></a>            <span class="n">print_listofdict</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-294"><a href="#SelfContextClipCMT-294"><span class="linenos">294</span></a>                <span class="n">dict_context</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;llm_latest&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}],</span> <span class="n">mod</span><span class="o">=</span><span class="s1">&#39;env_clip&#39;</span>
</span><span id="SelfContextClipCMT-295"><a href="#SelfContextClipCMT-295"><span class="linenos">295</span></a>            <span class="p">)</span>  <span class="c1">#  Logs the updated context and LLM output to a file</span>
</span><span id="SelfContextClipCMT-296"><a href="#SelfContextClipCMT-296"><span class="linenos">296</span></a>        <span class="n">output_llm_content</span> <span class="o">=</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT-297"><a href="#SelfContextClipCMT-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">latest_llm_interaction_socket_additional</span><span class="p">,</span> <span class="n">output_llm_content</span>
</span><span id="SelfContextClipCMT-298"><a href="#SelfContextClipCMT-298"><span class="linenos">298</span></a>
</span><span id="SelfContextClipCMT-299"><a href="#SelfContextClipCMT-299"><span class="linenos">299</span></a>
</span><span id="SelfContextClipCMT-300"><a href="#SelfContextClipCMT-300"><span class="linenos">300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">after_save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">this_interaction</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-301"><a href="#SelfContextClipCMT-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-302"><a href="#SelfContextClipCMT-302"><span class="linenos">302</span></a><span class="sd">        this_interaction = [</span>
</span><span id="SelfContextClipCMT-303"><a href="#SelfContextClipCMT-303"><span class="linenos">303</span></a><span class="sd">            init msg,</span>
</span><span id="SelfContextClipCMT-304"><a href="#SelfContextClipCMT-304"><span class="linenos">304</span></a><span class="sd">            ...,</span>
</span><span id="SelfContextClipCMT-305"><a href="#SelfContextClipCMT-305"><span class="linenos">305</span></a><span class="sd">            init msg,</span>
</span><span id="SelfContextClipCMT-306"><a href="#SelfContextClipCMT-306"><span class="linenos">306</span></a><span class="sd">            ...</span>
</span><span id="SelfContextClipCMT-307"><a href="#SelfContextClipCMT-307"><span class="linenos">307</span></a><span class="sd">            previous env msg,</span>
</span><span id="SelfContextClipCMT-308"><a href="#SelfContextClipCMT-308"><span class="linenos">308</span></a><span class="sd">            latest llm msg,</span>
</span><span id="SelfContextClipCMT-309"><a href="#SelfContextClipCMT-309"><span class="linenos">309</span></a><span class="sd">        ]</span>
</span><span id="SelfContextClipCMT-310"><a href="#SelfContextClipCMT-310"><span class="linenos">310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-311"><a href="#SelfContextClipCMT-311"><span class="linenos">311</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="SelfContextClipCMT-312"><a href="#SelfContextClipCMT-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-313"><a href="#SelfContextClipCMT-313"><span class="linenos">313</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT-314"><a href="#SelfContextClipCMT-314"><span class="linenos">314</span></a>
</span><span id="SelfContextClipCMT-315"><a href="#SelfContextClipCMT-315"><span class="linenos">315</span></a>        <span class="n">clip_token_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_clip_trigger_token_num</span>
</span><span id="SelfContextClipCMT-316"><a href="#SelfContextClipCMT-316"><span class="linenos">316</span></a>        <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-317"><a href="#SelfContextClipCMT-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_seq_length</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">clip_token_cnt</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-318"><a href="#SelfContextClipCMT-318"><span class="linenos">318</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT-319"><a href="#SelfContextClipCMT-319"><span class="linenos">319</span></a>
</span><span id="SelfContextClipCMT-320"><a href="#SelfContextClipCMT-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-321"><a href="#SelfContextClipCMT-321"><span class="linenos">321</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT-322"><a href="#SelfContextClipCMT-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SelfContextClipCMT-323"><a href="#SelfContextClipCMT-323"><span class="linenos">323</span></a>
</span><span id="SelfContextClipCMT-324"><a href="#SelfContextClipCMT-324"><span class="linenos">324</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">generated_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl_new_request_from_previous_interaction</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-325"><a href="#SelfContextClipCMT-325"><span class="linenos">325</span></a>            <span class="n">new_message</span><span class="o">=</span><span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-326"><a href="#SelfContextClipCMT-326"><span class="linenos">326</span></a>                <span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-327"><a href="#SelfContextClipCMT-327"><span class="linenos">327</span></a>                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-328"><a href="#SelfContextClipCMT-328"><span class="linenos">328</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-329"><a href="#SelfContextClipCMT-329"><span class="linenos">329</span></a><span class="s2">                    Your new task is to inspect each `Environment Response` and `Assistant Response` messages,</span>
</span><span id="SelfContextClipCMT-330"><a href="#SelfContextClipCMT-330"><span class="linenos">330</span></a><span class="s2">                    and determine whether each message is useful for the next-step decision-making.</span>
</span><span id="SelfContextClipCMT-331"><a href="#SelfContextClipCMT-331"><span class="linenos">331</span></a><span class="s2">                    Generate a json structure following the format below:</span>
</span><span id="SelfContextClipCMT-332"><a href="#SelfContextClipCMT-332"><span class="linenos">332</span></a><span class="s2">                    ```json</span>
</span><span id="SelfContextClipCMT-333"><a href="#SelfContextClipCMT-333"><span class="linenos">333</span></a><span class="s2">                    [</span>
</span><span id="SelfContextClipCMT-334"><a href="#SelfContextClipCMT-334"><span class="linenos">334</span></a><span class="s2">                        {&quot;id&quot;:&quot;ARXXX or ERXXX&quot;, &quot;useful&quot;:true or false, &quot;action&quot;: &quot;keep or remove or compress&quot;},</span>
</span><span id="SelfContextClipCMT-335"><a href="#SelfContextClipCMT-335"><span class="linenos">335</span></a><span class="s2">                        ...,</span>
</span><span id="SelfContextClipCMT-336"><a href="#SelfContextClipCMT-336"><span class="linenos">336</span></a><span class="s2">                        {&quot;id&quot;:&quot;ARXXX or ERXXX&quot;, &quot;useful&quot;:true or false, &quot;action&quot;: &quot;keep or remove or compress&quot;},</span>
</span><span id="SelfContextClipCMT-337"><a href="#SelfContextClipCMT-337"><span class="linenos">337</span></a><span class="s2">                    ]</span>
</span><span id="SelfContextClipCMT-338"><a href="#SelfContextClipCMT-338"><span class="linenos">338</span></a><span class="s2">                    ```</span>
</span><span id="SelfContextClipCMT-339"><a href="#SelfContextClipCMT-339"><span class="linenos">339</span></a>
</span><span id="SelfContextClipCMT-340"><a href="#SelfContextClipCMT-340"><span class="linenos">340</span></a><span class="s2">                    For example:</span>
</span><span id="SelfContextClipCMT-341"><a href="#SelfContextClipCMT-341"><span class="linenos">341</span></a><span class="s2">                    ```json</span>
</span><span id="SelfContextClipCMT-342"><a href="#SelfContextClipCMT-342"><span class="linenos">342</span></a><span class="s2">                    [</span>
</span><span id="SelfContextClipCMT-343"><a href="#SelfContextClipCMT-343"><span class="linenos">343</span></a><span class="s2">                        {&quot;id&quot;:&quot;ER001&quot;, &quot;useful&quot;:true, &quot;action&quot;: &quot;keep&quot;},</span>
</span><span id="SelfContextClipCMT-344"><a href="#SelfContextClipCMT-344"><span class="linenos">344</span></a><span class="s2">                        {&quot;id&quot;:&quot;AR001&quot;, &quot;useful&quot;:false, &quot;action&quot;: &quot;remove&quot;},</span>
</span><span id="SelfContextClipCMT-345"><a href="#SelfContextClipCMT-345"><span class="linenos">345</span></a><span class="s2">                        ...</span>
</span><span id="SelfContextClipCMT-346"><a href="#SelfContextClipCMT-346"><span class="linenos">346</span></a><span class="s2">                    ]</span>
</span><span id="SelfContextClipCMT-347"><a href="#SelfContextClipCMT-347"><span class="linenos">347</span></a><span class="s2">                    ```</span>
</span><span id="SelfContextClipCMT-348"><a href="#SelfContextClipCMT-348"><span class="linenos">348</span></a>
</span><span id="SelfContextClipCMT-349"><a href="#SelfContextClipCMT-349"><span class="linenos">349</span></a><span class="s2">                    Rules:</span>
</span><span id="SelfContextClipCMT-350"><a href="#SelfContextClipCMT-350"><span class="linenos">350</span></a><span class="s2">                    - If the message contains useful information for future decisions, set &quot;useful&quot;:true and &quot;action&quot;:&quot;keep&quot;.</span>
</span><span id="SelfContextClipCMT-351"><a href="#SelfContextClipCMT-351"><span class="linenos">351</span></a><span class="s2">                    - If the message records important previous action or environment feedback, set &quot;useful&quot;:true and &quot;action&quot;:&quot;keep&quot;.</span>
</span><span id="SelfContextClipCMT-352"><a href="#SelfContextClipCMT-352"><span class="linenos">352</span></a><span class="s2">                    - If the message is very long and very redundant, set &quot;useful&quot;:true and &quot;action&quot;:&quot;compress&quot;.</span>
</span><span id="SelfContextClipCMT-353"><a href="#SelfContextClipCMT-353"><span class="linenos">353</span></a><span class="s2">                    - If the message is completely irrelevant, set &quot;useful&quot;:false and &quot;action&quot;:&quot;remove&quot;. Note that important failures should be preserved, because learning from past is vital.</span>
</span><span id="SelfContextClipCMT-354"><a href="#SelfContextClipCMT-354"><span class="linenos">354</span></a><span class="s2">                    - Ignore messages without id=XXX tags, where XXX is a 3-digit number.</span>
</span><span id="SelfContextClipCMT-355"><a href="#SelfContextClipCMT-355"><span class="linenos">355</span></a><span class="s2">                    - Ensure the JSON is properly formatted and valid.</span>
</span><span id="SelfContextClipCMT-356"><a href="#SelfContextClipCMT-356"><span class="linenos">356</span></a><span class="s2">                    - Remove or compress at least one message, because token limit is already reached.</span>
</span><span id="SelfContextClipCMT-357"><a href="#SelfContextClipCMT-357"><span class="linenos">357</span></a><span class="s2">                    - At least remove (or compress) one message.</span>
</span><span id="SelfContextClipCMT-358"><a href="#SelfContextClipCMT-358"><span class="linenos">358</span></a><span class="s2">                    - There must be no more than 2 &quot;compress&quot; actions in total, because &quot;compress&quot; action will cost considerable amount of time.</span>
</span><span id="SelfContextClipCMT-359"><a href="#SelfContextClipCMT-359"><span class="linenos">359</span></a>
</span><span id="SelfContextClipCMT-360"><a href="#SelfContextClipCMT-360"><span class="linenos">360</span></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">),</span>
</span><span id="SelfContextClipCMT-361"><a href="#SelfContextClipCMT-361"><span class="linenos">361</span></a>                <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-362"><a href="#SelfContextClipCMT-362"><span class="linenos">362</span></a>                <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-363"><a href="#SelfContextClipCMT-363"><span class="linenos">363</span></a>            <span class="p">),</span>
</span><span id="SelfContextClipCMT-364"><a href="#SelfContextClipCMT-364"><span class="linenos">364</span></a>            <span class="n">this_interaction</span><span class="o">=</span><span class="n">this_interaction</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-365"><a href="#SelfContextClipCMT-365"><span class="linenos">365</span></a>            <span class="n">strip_think</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-366"><a href="#SelfContextClipCMT-366"><span class="linenos">366</span></a>        <span class="p">)</span>
</span><span id="SelfContextClipCMT-367"><a href="#SelfContextClipCMT-367"><span class="linenos">367</span></a>
</span><span id="SelfContextClipCMT-368"><a href="#SelfContextClipCMT-368"><span class="linenos">368</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-369"><a href="#SelfContextClipCMT-369"><span class="linenos">369</span></a>            <span class="n">llm_output_content</span> <span class="o">=</span> <span class="n">generated_content</span> <span class="o">=</span> <span class="n">generated_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT-370"><a href="#SelfContextClipCMT-370"><span class="linenos">370</span></a>            <span class="k">if</span> <span class="n">llm_output_content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-371"><a href="#SelfContextClipCMT-371"><span class="linenos">371</span></a>                <span class="n">extracted_content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">llm_output_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT-372"><a href="#SelfContextClipCMT-372"><span class="linenos">372</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-373"><a href="#SelfContextClipCMT-373"><span class="linenos">373</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find ``` in llm_output content: </span><span class="si">{</span><span class="n">llm_output_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-374"><a href="#SelfContextClipCMT-374"><span class="linenos">374</span></a>            <span class="k">if</span> <span class="n">extracted_content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-375"><a href="#SelfContextClipCMT-375"><span class="linenos">375</span></a>                <span class="n">extracted_content</span> <span class="o">=</span> <span class="n">extracted_content</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT-376"><a href="#SelfContextClipCMT-376"><span class="linenos">376</span></a>            <span class="n">extracted_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-377"><a href="#SelfContextClipCMT-377"><span class="linenos">377</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">extracted_json</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-378"><a href="#SelfContextClipCMT-378"><span class="linenos">378</span></a>                <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="s1">&#39;useful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="s1">&#39;action&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-379"><a href="#SelfContextClipCMT-379"><span class="linenos">379</span></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each item must contain &#39;id&#39;, &#39;useful&#39;, and &#39;action&#39; fields. Error in item: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-380"><a href="#SelfContextClipCMT-380"><span class="linenos">380</span></a>                <span class="n">message_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="SelfContextClipCMT-381"><a href="#SelfContextClipCMT-381"><span class="linenos">381</span></a>                <span class="n">message_action</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
</span><span id="SelfContextClipCMT-382"><a href="#SelfContextClipCMT-382"><span class="linenos">382</span></a>                <span class="c1"># find message from self.full_context</span>
</span><span id="SelfContextClipCMT-383"><a href="#SelfContextClipCMT-383"><span class="linenos">383</span></a>                <span class="c1">## match latest_llm_interaction_socket_additional and match self.full_context</span>
</span><span id="SelfContextClipCMT-384"><a href="#SelfContextClipCMT-384"><span class="linenos">384</span></a>                <span class="n">from_uuid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SelfContextClipCMT-385"><a href="#SelfContextClipCMT-385"><span class="linenos">385</span></a>                <span class="k">for</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="n">this_interaction</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-386"><a href="#SelfContextClipCMT-386"><span class="linenos">386</span></a>                    <span class="k">if</span> <span class="n">message_id</span> <span class="ow">in</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-387"><a href="#SelfContextClipCMT-387"><span class="linenos">387</span></a>                        <span class="n">from_uuid</span> <span class="o">=</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span>
</span><span id="SelfContextClipCMT-388"><a href="#SelfContextClipCMT-388"><span class="linenos">388</span></a>                        <span class="k">break</span>
</span><span id="SelfContextClipCMT-389"><a href="#SelfContextClipCMT-389"><span class="linenos">389</span></a>                <span class="k">if</span> <span class="n">from_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-390"><a href="#SelfContextClipCMT-390"><span class="linenos">390</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find message_id </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> in `this_interaction`&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-391"><a href="#SelfContextClipCMT-391"><span class="linenos">391</span></a>                <span class="n">target_msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SelfContextClipCMT-392"><a href="#SelfContextClipCMT-392"><span class="linenos">392</span></a>                <span class="n">target_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="SelfContextClipCMT-393"><a href="#SelfContextClipCMT-393"><span class="linenos">393</span></a>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-394"><a href="#SelfContextClipCMT-394"><span class="linenos">394</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">from_uuid</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-395"><a href="#SelfContextClipCMT-395"><span class="linenos">395</span></a>                        <span class="n">target_msg</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="SelfContextClipCMT-396"><a href="#SelfContextClipCMT-396"><span class="linenos">396</span></a>                        <span class="n">target_index</span> <span class="o">=</span> <span class="n">index</span>
</span><span id="SelfContextClipCMT-397"><a href="#SelfContextClipCMT-397"><span class="linenos">397</span></a>                        <span class="k">break</span>
</span><span id="SelfContextClipCMT-398"><a href="#SelfContextClipCMT-398"><span class="linenos">398</span></a>                <span class="k">if</span> <span class="n">target_msg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-399"><a href="#SelfContextClipCMT-399"><span class="linenos">399</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find message_id </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> in full_context&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-400"><a href="#SelfContextClipCMT-400"><span class="linenos">400</span></a>
</span><span id="SelfContextClipCMT-401"><a href="#SelfContextClipCMT-401"><span class="linenos">401</span></a>                <span class="c1">## take actions</span>
</span><span id="SelfContextClipCMT-402"><a href="#SelfContextClipCMT-402"><span class="linenos">402</span></a>                <span class="k">if</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-403"><a href="#SelfContextClipCMT-403"><span class="linenos">403</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-404"><a href="#SelfContextClipCMT-404"><span class="linenos">404</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">author</span><span class="o">+</span><span class="s2">&quot;(discard)&quot;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-405"><a href="#SelfContextClipCMT-405"><span class="linenos">405</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-406"><a href="#SelfContextClipCMT-406"><span class="linenos">406</span></a>                        <span class="n">content</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># keep original content</span>
</span><span id="SelfContextClipCMT-407"><a href="#SelfContextClipCMT-407"><span class="linenos">407</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-408"><a href="#SelfContextClipCMT-408"><span class="linenos">408</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-409"><a href="#SelfContextClipCMT-409"><span class="linenos">409</span></a>                    <span class="p">)</span>
</span><span id="SelfContextClipCMT-410"><a href="#SelfContextClipCMT-410"><span class="linenos">410</span></a>                <span class="k">elif</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;compress&#39;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-411"><a href="#SelfContextClipCMT-411"><span class="linenos">411</span></a>                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">message_id</span>
</span><span id="SelfContextClipCMT-412"><a href="#SelfContextClipCMT-412"><span class="linenos">412</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">generated_compressed_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl_new_request_from_previous_interaction</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-413"><a href="#SelfContextClipCMT-413"><span class="linenos">413</span></a>                        <span class="n">new_message</span><span class="o">=</span><span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-414"><a href="#SelfContextClipCMT-414"><span class="linenos">414</span></a>                            <span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-415"><a href="#SelfContextClipCMT-415"><span class="linenos">415</span></a>                            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-416"><a href="#SelfContextClipCMT-416"><span class="linenos">416</span></a>                            <span class="n">content</span><span class="o">=</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-417"><a href="#SelfContextClipCMT-417"><span class="linenos">417</span></a><span class="s2">                                Your new task is to inspect </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">, and filter out all redundant information, and only keep the most important information that is useful for future decision-making.</span>
</span><span id="SelfContextClipCMT-418"><a href="#SelfContextClipCMT-418"><span class="linenos">418</span></a><span class="s2">                                For example, if the content is a long text with multiple paragraphs, you should only preseve the key paragraphs and use ... to replace the rest.</span>
</span><span id="SelfContextClipCMT-419"><a href="#SelfContextClipCMT-419"><span class="linenos">419</span></a><span class="s2">                                If the content is a long list of data / dict / json, you should only preseve the key items and use ... to replace the rest.</span>
</span><span id="SelfContextClipCMT-420"><a href="#SelfContextClipCMT-420"><span class="linenos">420</span></a><span class="s2">                                Be careful to preserve all information that might be useful in the future. You should at least reduce 50% of </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">.</span>
</span><span id="SelfContextClipCMT-421"><a href="#SelfContextClipCMT-421"><span class="linenos">421</span></a><span class="s2">                                Remember wrap your answer with ```</span>
</span><span id="SelfContextClipCMT-422"><a href="#SelfContextClipCMT-422"><span class="linenos">422</span></a>
</span><span id="SelfContextClipCMT-423"><a href="#SelfContextClipCMT-423"><span class="linenos">423</span></a><span class="s2">                                Your response should be like:</span>
</span><span id="SelfContextClipCMT-424"><a href="#SelfContextClipCMT-424"><span class="linenos">424</span></a><span class="s2">                                ```</span>
</span><span id="SelfContextClipCMT-425"><a href="#SelfContextClipCMT-425"><span class="linenos">425</span></a><span class="s2">                                ...content after filtering...</span>
</span><span id="SelfContextClipCMT-426"><a href="#SelfContextClipCMT-426"><span class="linenos">426</span></a><span class="s2">                                ```</span>
</span><span id="SelfContextClipCMT-427"><a href="#SelfContextClipCMT-427"><span class="linenos">427</span></a><span class="s2">                            &quot;&quot;&quot;</span><span class="p">),</span>
</span><span id="SelfContextClipCMT-428"><a href="#SelfContextClipCMT-428"><span class="linenos">428</span></a>                            <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-429"><a href="#SelfContextClipCMT-429"><span class="linenos">429</span></a>                            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-430"><a href="#SelfContextClipCMT-430"><span class="linenos">430</span></a>                        <span class="p">),</span>
</span><span id="SelfContextClipCMT-431"><a href="#SelfContextClipCMT-431"><span class="linenos">431</span></a>                        <span class="n">this_interaction</span><span class="o">=</span><span class="n">this_interaction</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># exclude the latest llm message</span>
</span><span id="SelfContextClipCMT-432"><a href="#SelfContextClipCMT-432"><span class="linenos">432</span></a>                        <span class="n">strip_think</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-433"><a href="#SelfContextClipCMT-433"><span class="linenos">433</span></a>                    <span class="p">)</span>
</span><span id="SelfContextClipCMT-434"><a href="#SelfContextClipCMT-434"><span class="linenos">434</span></a>                    <span class="k">if</span> <span class="n">generated_compressed_content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-435"><a href="#SelfContextClipCMT-435"><span class="linenos">435</span></a>                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find ``` in llm_output content: </span><span class="si">{</span><span class="n">generated_compressed_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-436"><a href="#SelfContextClipCMT-436"><span class="linenos">436</span></a>                    <span class="n">compressed_content</span> <span class="o">=</span> <span class="n">generated_compressed_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT-437"><a href="#SelfContextClipCMT-437"><span class="linenos">437</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-438"><a href="#SelfContextClipCMT-438"><span class="linenos">438</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-439"><a href="#SelfContextClipCMT-439"><span class="linenos">439</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-440"><a href="#SelfContextClipCMT-440"><span class="linenos">440</span></a>                        <span class="n">content</span><span class="o">=</span><span class="n">compressed_content</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-441"><a href="#SelfContextClipCMT-441"><span class="linenos">441</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-442"><a href="#SelfContextClipCMT-442"><span class="linenos">442</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-443"><a href="#SelfContextClipCMT-443"><span class="linenos">443</span></a>                    <span class="p">)</span>
</span><span id="SelfContextClipCMT-444"><a href="#SelfContextClipCMT-444"><span class="linenos">444</span></a>                <span class="k">elif</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;keep&#39;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-445"><a href="#SelfContextClipCMT-445"><span class="linenos">445</span></a>                    <span class="k">continue</span>
</span><span id="SelfContextClipCMT-446"><a href="#SelfContextClipCMT-446"><span class="linenos">446</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-447"><a href="#SelfContextClipCMT-447"><span class="linenos">447</span></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action </span><span class="si">{</span><span class="n">message_action</span><span class="si">}</span><span class="s2">, must be one of [&#39;remove&#39;, &#39;keep&#39;, &#39;compress&#39;]&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-448"><a href="#SelfContextClipCMT-448"><span class="linenos">448</span></a>
</span><span id="SelfContextClipCMT-449"><a href="#SelfContextClipCMT-449"><span class="linenos">449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-450"><a href="#SelfContextClipCMT-450"><span class="linenos">450</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing llm_output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-451"><a href="#SelfContextClipCMT-451"><span class="linenos">451</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing llm_output&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT-452"><a href="#SelfContextClipCMT-452"><span class="linenos">452</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT-453"><a href="#SelfContextClipCMT-453"><span class="linenos">453</span></a>
</span><span id="SelfContextClipCMT-454"><a href="#SelfContextClipCMT-454"><span class="linenos">454</span></a>
</span><span id="SelfContextClipCMT-455"><a href="#SelfContextClipCMT-455"><span class="linenos">455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">replace_full_context_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-456"><a href="#SelfContextClipCMT-456"><span class="linenos">456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-457"><a href="#SelfContextClipCMT-457"><span class="linenos">457</span></a><span class="sd">        Replaces the content of a message in the full context with new content if the match content is found.</span>
</span><span id="SelfContextClipCMT-458"><a href="#SelfContextClipCMT-458"><span class="linenos">458</span></a>
</span><span id="SelfContextClipCMT-459"><a href="#SelfContextClipCMT-459"><span class="linenos">459</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-460"><a href="#SelfContextClipCMT-460"><span class="linenos">460</span></a><span class="sd">            match_content (str): The content to search for in the full context.</span>
</span><span id="SelfContextClipCMT-461"><a href="#SelfContextClipCMT-461"><span class="linenos">461</span></a><span class="sd">            new_content (str): The new content to replace the matched content with.</span>
</span><span id="SelfContextClipCMT-462"><a href="#SelfContextClipCMT-462"><span class="linenos">462</span></a>
</span><span id="SelfContextClipCMT-463"><a href="#SelfContextClipCMT-463"><span class="linenos">463</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-464"><a href="#SelfContextClipCMT-464"><span class="linenos">464</span></a><span class="sd">            bool: True if the replacement was successful, False otherwise.</span>
</span><span id="SelfContextClipCMT-465"><a href="#SelfContextClipCMT-465"><span class="linenos">465</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-466"><a href="#SelfContextClipCMT-466"><span class="linenos">466</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SelfContextClipCMT-467"><a href="#SelfContextClipCMT-467"><span class="linenos">467</span></a>        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">)):</span>
</span><span id="SelfContextClipCMT-468"><a href="#SelfContextClipCMT-468"><span class="linenos">468</span></a>            <span class="n">ext_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="SelfContextClipCMT-469"><a href="#SelfContextClipCMT-469"><span class="linenos">469</span></a>            <span class="k">if</span> <span class="n">match_content</span> <span class="ow">in</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">:</span>
</span><span id="SelfContextClipCMT-470"><a href="#SelfContextClipCMT-470"><span class="linenos">470</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SelfContextClipCMT-471"><a href="#SelfContextClipCMT-471"><span class="linenos">471</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT-472"><a href="#SelfContextClipCMT-472"><span class="linenos">472</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-473"><a href="#SelfContextClipCMT-473"><span class="linenos">473</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-474"><a href="#SelfContextClipCMT-474"><span class="linenos">474</span></a>                    <span class="n">content</span><span class="o">=</span><span class="n">new_content</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-475"><a href="#SelfContextClipCMT-475"><span class="linenos">475</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-476"><a href="#SelfContextClipCMT-476"><span class="linenos">476</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT-477"><a href="#SelfContextClipCMT-477"><span class="linenos">477</span></a>                <span class="p">)</span>  <span class="c1">#  Replace the matched content with the new content</span>
</span><span id="SelfContextClipCMT-478"><a href="#SelfContextClipCMT-478"><span class="linenos">478</span></a>                <span class="c1"># print_dict({match_content: new_content})</span>
</span><span id="SelfContextClipCMT-479"><a href="#SelfContextClipCMT-479"><span class="linenos">479</span></a>                <span class="k">return</span> <span class="n">success</span>
</span><span id="SelfContextClipCMT-480"><a href="#SelfContextClipCMT-480"><span class="linenos">480</span></a>        <span class="k">return</span> <span class="n">success</span>
</span><span id="SelfContextClipCMT-481"><a href="#SelfContextClipCMT-481"><span class="linenos">481</span></a>
</span><span id="SelfContextClipCMT-482"><a href="#SelfContextClipCMT-482"><span class="linenos">482</span></a>
</span><span id="SelfContextClipCMT-483"><a href="#SelfContextClipCMT-483"><span class="linenos">483</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">input_msg_ref</span><span class="p">):</span>
</span><span id="SelfContextClipCMT-484"><a href="#SelfContextClipCMT-484"><span class="linenos">484</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-485"><a href="#SelfContextClipCMT-485"><span class="linenos">485</span></a><span class="sd">        Saves the LLM&#39;s output, updates the grouped steps with the latest interaction, and resets the latest LLM interaction socket.</span>
</span><span id="SelfContextClipCMT-486"><a href="#SelfContextClipCMT-486"><span class="linenos">486</span></a>
</span><span id="SelfContextClipCMT-487"><a href="#SelfContextClipCMT-487"><span class="linenos">487</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT-488"><a href="#SelfContextClipCMT-488"><span class="linenos">488</span></a><span class="sd">            llm_output (str): The output generated by the LLM.</span>
</span><span id="SelfContextClipCMT-489"><a href="#SelfContextClipCMT-489"><span class="linenos">489</span></a><span class="sd">            input_msg_ref (str): The reference to the input message that triggered the LLM&#39;s response.</span>
</span><span id="SelfContextClipCMT-490"><a href="#SelfContextClipCMT-490"><span class="linenos">490</span></a>
</span><span id="SelfContextClipCMT-491"><a href="#SelfContextClipCMT-491"><span class="linenos">491</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT-492"><a href="#SelfContextClipCMT-492"><span class="linenos">492</span></a><span class="sd">            None</span>
</span><span id="SelfContextClipCMT-493"><a href="#SelfContextClipCMT-493"><span class="linenos">493</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT-494"><a href="#SelfContextClipCMT-494"><span class="linenos">494</span></a>        <span class="n">ext_msg</span> <span class="o">=</span> <span class="n">Linear_CMT</span><span class="o">.</span><span class="n">save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">input_msg_ref</span><span class="p">)</span>  <span class="c1">#  Save the LLM output and get the extended message</span>
</span><span id="SelfContextClipCMT-495"><a href="#SelfContextClipCMT-495"><span class="linenos">495</span></a>        <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">+</span> <span class="p">[</span><span class="n">ext_msg</span><span class="p">])</span>  <span class="c1">#  Create a deep copy of the latest interaction including the new message</span>
</span><span id="SelfContextClipCMT-496"><a href="#SelfContextClipCMT-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grouped_steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">this_interaction</span><span class="p">]</span>  <span class="c1">#  Append the new interaction to the grouped steps</span>
</span><span id="SelfContextClipCMT-497"><a href="#SelfContextClipCMT-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">after_save_llm_output</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>  <span class="c1">#  Call the after-save hook for any additional processing</span>
</span><span id="SelfContextClipCMT-498"><a href="#SelfContextClipCMT-498"><span class="linenos">498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#  Reset the latest LLM interaction socket</span>
</span><span id="SelfContextClipCMT-499"><a href="#SelfContextClipCMT-499"><span class="linenos">499</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>A non-linear context manager template that handles the conversation flow between LLM and environment.</p>
</div>


                            <div id="SelfContextClipCMT.__init__" class="classattr">
                                        <input id="SelfContextClipCMT.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SelfContextClipCMT</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config</span>, </span><span class="param"><span class="n">tokenizer</span>, </span><span class="param"><span class="n">llm_chat_fn</span></span>)</span>

                <label class="view-source-button" for="SelfContextClipCMT.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.__init__-64"><a href="#SelfContextClipCMT.__init__-64"><span class="linenos">64</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">llm_chat_fn</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.__init__-65"><a href="#SelfContextClipCMT.__init__-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_chat_fn</span> <span class="o">=</span> <span class="n">llm_chat_fn</span>
</span><span id="SelfContextClipCMT.__init__-66"><a href="#SelfContextClipCMT.__init__-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alien_llm_chat_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">construct_alien_llm_chat_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.__init__-67"><a href="#SelfContextClipCMT.__init__-67"><span class="linenos">67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="SelfContextClipCMT.__init__-68"><a href="#SelfContextClipCMT.__init__-68"><span class="linenos">68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="SelfContextClipCMT.__init__-69"><a href="#SelfContextClipCMT.__init__-69"><span class="linenos">69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console_debug_mode</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SelfContextClipCMT.__init__-70"><a href="#SelfContextClipCMT.__init__-70"><span class="linenos">70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">force_think</span>
</span><span id="SelfContextClipCMT.__init__-71"><a href="#SelfContextClipCMT.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">env_service</span><span class="o">.</span><span class="n">env_feedin_preference</span>
</span><span id="SelfContextClipCMT.__init__-72"><a href="#SelfContextClipCMT.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_train_sp_action</span>
</span><span id="SelfContextClipCMT.__init__-73"><a href="#SelfContextClipCMT.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SelfContextClipCMT.__init__-74"><a href="#SelfContextClipCMT.__init__-74"><span class="linenos">74</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.__init__-75"><a href="#SelfContextClipCMT.__init__-75"><span class="linenos">75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.__init__-76"><a href="#SelfContextClipCMT.__init__-76"><span class="linenos">76</span></a><span class="s2">                Additional requirements: Think before action! You must think step by step before your next action, and you must use &lt;think&gt;...&lt;/think&gt; to wrap your thinking process before finally produce your answer with </span><span class="se">\\</span><span class="s2">box</span><span class="si">{}</span><span class="s2">.</span>
</span><span id="SelfContextClipCMT.__init__-77"><a href="#SelfContextClipCMT.__init__-77"><span class="linenos">77</span></a><span class="s2">                Your thought (&lt;think&gt;...&lt;/think&gt;) should be as short and concise as possible.</span>
</span><span id="SelfContextClipCMT.__init__-78"><a href="#SelfContextClipCMT.__init__-78"><span class="linenos">78</span></a><span class="s2">                For example:</span>
</span><span id="SelfContextClipCMT.__init__-79"><a href="#SelfContextClipCMT.__init__-79"><span class="linenos">79</span></a><span class="s2">                &lt;think&gt;...your thinking process...&lt;/think&gt;</span>
</span><span id="SelfContextClipCMT.__init__-80"><a href="#SelfContextClipCMT.__init__-80"><span class="linenos">80</span></a><span class="s2">                </span><span class="se">\\</span><span class="s2">box{...your final answer...}</span>
</span><span id="SelfContextClipCMT.__init__-81"><a href="#SelfContextClipCMT.__init__-81"><span class="linenos">81</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.__init__-82"><a href="#SelfContextClipCMT.__init__-82"><span class="linenos">82</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_feedin_preference</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.__init__-83"><a href="#SelfContextClipCMT.__init__-83"><span class="linenos">83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.__init__-84"><a href="#SelfContextClipCMT.__init__-84"><span class="linenos">84</span></a><span class="s2">                Additional requirements: Think before action! You must think step by step before your next action, and you must use &lt;think&gt;...&lt;/think&gt; to wrap your thinking process before finally produce the next-step action.</span>
</span><span id="SelfContextClipCMT.__init__-85"><a href="#SelfContextClipCMT.__init__-85"><span class="linenos">85</span></a><span class="s2">                Your thought (&lt;think&gt;...&lt;/think&gt;) should be as short and concise as possible.</span>
</span><span id="SelfContextClipCMT.__init__-86"><a href="#SelfContextClipCMT.__init__-86"><span class="linenos">86</span></a><span class="s2">                For example:</span>
</span><span id="SelfContextClipCMT.__init__-87"><a href="#SelfContextClipCMT.__init__-87"><span class="linenos">87</span></a><span class="s2">                &lt;think&gt;...your thinking process...&lt;/think&gt;</span>
</span><span id="SelfContextClipCMT.__init__-88"><a href="#SelfContextClipCMT.__init__-88"><span class="linenos">88</span></a><span class="s2">                ```python</span>
</span><span id="SelfContextClipCMT.__init__-89"><a href="#SelfContextClipCMT.__init__-89"><span class="linenos">89</span></a><span class="s2">                # your action here</span>
</span><span id="SelfContextClipCMT.__init__-90"><a href="#SelfContextClipCMT.__init__-90"><span class="linenos">90</span></a><span class="s2">                ```</span>
</span><span id="SelfContextClipCMT.__init__-91"><a href="#SelfContextClipCMT.__init__-91"><span class="linenos">91</span></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.__init__-92"><a href="#SelfContextClipCMT.__init__-92"><span class="linenos">92</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the Linear_CMT class with the provided configuration and tokenizer.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>config:</strong>  Configuration object containing environment and model settings.</li>
<li><strong>tokenizer:</strong>  Tokenizer instance for processing text.</li>
</ul>
</div>


                            </div>
                            <div id="SelfContextClipCMT.llm_chat_fn" class="classattr">
                                <div class="attr variable">
            <span class="name">llm_chat_fn</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.llm_chat_fn"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.alien_llm_chat_fn" class="classattr">
                                <div class="attr variable">
            <span class="name">alien_llm_chat_fn</span><span class="annotation">: Callable</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.alien_llm_chat_fn"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.latest_env_response_id" class="classattr">
                                <div class="attr variable">
            <span class="name">latest_env_response_id</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.latest_env_response_id"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.latest_env_response_content" class="classattr">
                                <div class="attr variable">
            <span class="name">latest_env_response_content</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.latest_env_response_content"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.console_debug_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">console_debug_mode</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.console_debug_mode"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.force_think" class="classattr">
                                <div class="attr variable">
            <span class="name">force_think</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.force_think"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.env_feedin_preference" class="classattr">
                                <div class="attr variable">
            <span class="name">env_feedin_preference</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.env_feedin_preference"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.train_sp_action" class="classattr">
                                <div class="attr variable">
            <span class="name">train_sp_action</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.train_sp_action"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.clipped_before" class="classattr">
                                <div class="attr variable">
            <span class="name">clipped_before</span>

        
    </div>
    <a class="headerlink" href="#SelfContextClipCMT.clipped_before"></a>
    
    

                            </div>
                            <div id="SelfContextClipCMT.post_tag_init_message_context" class="classattr">
                                        <input id="SelfContextClipCMT.post_tag_init_message_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">post_tag_init_message_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">content</span>, </span><span class="param"><span class="n">is_last</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.post_tag_init_message_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.post_tag_init_message_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.post_tag_init_message_context-94"><a href="#SelfContextClipCMT.post_tag_init_message_context-94"><span class="linenos"> 94</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_init_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-95"><a href="#SelfContextClipCMT.post_tag_init_message_context-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-96"><a href="#SelfContextClipCMT.post_tag_init_message_context-96"><span class="linenos"> 96</span></a><span class="sd">        Processes the content of a message, ensuring it is properly formatted and adding additional prompts if necessary.</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-97"><a href="#SelfContextClipCMT.post_tag_init_message_context-97"><span class="linenos"> 97</span></a>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-98"><a href="#SelfContextClipCMT.post_tag_init_message_context-98"><span class="linenos"> 98</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-99"><a href="#SelfContextClipCMT.post_tag_init_message_context-99"><span class="linenos"> 99</span></a><span class="sd">            content (str): The content of the message to be processed.</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-100"><a href="#SelfContextClipCMT.post_tag_init_message_context-100"><span class="linenos">100</span></a><span class="sd">            is_last (bool): A flag indicating whether this is the last message in the sequence.</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-101"><a href="#SelfContextClipCMT.post_tag_init_message_context-101"><span class="linenos">101</span></a>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-102"><a href="#SelfContextClipCMT.post_tag_init_message_context-102"><span class="linenos">102</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-103"><a href="#SelfContextClipCMT.post_tag_init_message_context-103"><span class="linenos">103</span></a><span class="sd">            str: The processed content of the message.</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-104"><a href="#SelfContextClipCMT.post_tag_init_message_context-104"><span class="linenos">104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-105"><a href="#SelfContextClipCMT.post_tag_init_message_context-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="n">is_last</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-106"><a href="#SelfContextClipCMT.post_tag_init_message_context-106"><span class="linenos">106</span></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Ensure the content is stripped of leading/trailing whitespace</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-107"><a href="#SelfContextClipCMT.post_tag_init_message_context-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="n">is_last</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-108"><a href="#SelfContextClipCMT.post_tag_init_message_context-108"><span class="linenos">108</span></a>            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span>  <span class="c1">#  Append the force_think_prompt if this is the last message and force_think is enabled</span>
</span><span id="SelfContextClipCMT.post_tag_init_message_context-109"><a href="#SelfContextClipCMT.post_tag_init_message_context-109"><span class="linenos">109</span></a>        <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Return the final processed content</span>
</span></pre></div>


            <div class="docstring"><p>Processes the content of a message, ensuring it is properly formatted and adding additional prompts if necessary.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>content (str):</strong>  The content of the message to be processed.</li>
<li><strong>is_last (bool):</strong>  A flag indicating whether this is the last message in the sequence.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>str: The processed content of the message.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.post_tag_env_message_context" class="classattr">
                                        <input id="SelfContextClipCMT.post_tag_env_message_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">post_tag_env_message_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">content</span>, </span><span class="param"><span class="n">turn</span>, </span><span class="param"><span class="n">is_last</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.post_tag_env_message_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.post_tag_env_message_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.post_tag_env_message_context-111"><a href="#SelfContextClipCMT.post_tag_env_message_context-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_env_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-112"><a href="#SelfContextClipCMT.post_tag_env_message_context-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-113"><a href="#SelfContextClipCMT.post_tag_env_message_context-113"><span class="linenos">113</span></a><span class="sd">        Formats and tags a message from the environment, appending an identifier based on the turn number.</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-114"><a href="#SelfContextClipCMT.post_tag_env_message_context-114"><span class="linenos">114</span></a><span class="sd">        Updates the internal state with the latest environment response and its ID.</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-115"><a href="#SelfContextClipCMT.post_tag_env_message_context-115"><span class="linenos">115</span></a><span class="sd">        If the message is the last and `force_think` is enabled, appends a prompt for further thinking.</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-116"><a href="#SelfContextClipCMT.post_tag_env_message_context-116"><span class="linenos">116</span></a>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-117"><a href="#SelfContextClipCMT.post_tag_env_message_context-117"><span class="linenos">117</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-118"><a href="#SelfContextClipCMT.post_tag_env_message_context-118"><span class="linenos">118</span></a><span class="sd">            content (str): The content of the message from the environment.</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-119"><a href="#SelfContextClipCMT.post_tag_env_message_context-119"><span class="linenos">119</span></a><span class="sd">            turn (int): The turn number of the message, must be in the range [0, 99).</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-120"><a href="#SelfContextClipCMT.post_tag_env_message_context-120"><span class="linenos">120</span></a><span class="sd">            is_last (bool): A flag indicating if this is the last message in the conversation.</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-121"><a href="#SelfContextClipCMT.post_tag_env_message_context-121"><span class="linenos">121</span></a>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-122"><a href="#SelfContextClipCMT.post_tag_env_message_context-122"><span class="linenos">122</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-123"><a href="#SelfContextClipCMT.post_tag_env_message_context-123"><span class="linenos">123</span></a><span class="sd">            str: The formatted and tagged message content.</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-124"><a href="#SelfContextClipCMT.post_tag_env_message_context-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-125"><a href="#SelfContextClipCMT.post_tag_env_message_context-125"><span class="linenos">125</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-126"><a href="#SelfContextClipCMT.post_tag_env_message_context-126"><span class="linenos">126</span></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;turn must be in the range [0, 99)&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-127"><a href="#SelfContextClipCMT.post_tag_env_message_context-127"><span class="linenos">127</span></a>        <span class="n">turn_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">turn</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-128"><a href="#SelfContextClipCMT.post_tag_env_message_context-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ER</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1">#  Update the latest environment response ID</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-129"><a href="#SelfContextClipCMT.post_tag_env_message_context-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Update the latest environment response content</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-130"><a href="#SelfContextClipCMT.post_tag_env_message_context-130"><span class="linenos">130</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-131"><a href="#SelfContextClipCMT.post_tag_env_message_context-131"><span class="linenos">131</span></a><span class="s2">            [Environment Response, id=ER</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">]</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-132"><a href="#SelfContextClipCMT.post_tag_env_message_context-132"><span class="linenos">132</span></a><span class="s2">            ---</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-133"><a href="#SelfContextClipCMT.post_tag_env_message_context-133"><span class="linenos">133</span></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Format and tag the message content</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-134"><a href="#SelfContextClipCMT.post_tag_env_message_context-134"><span class="linenos">134</span></a>        <span class="k">if</span> <span class="n">is_last</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-135"><a href="#SelfContextClipCMT.post_tag_env_message_context-135"><span class="linenos">135</span></a>            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_think_prompt</span>  <span class="c1">#  Append the force think prompt if necessary</span>
</span><span id="SelfContextClipCMT.post_tag_env_message_context-136"><a href="#SelfContextClipCMT.post_tag_env_message_context-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="n">content</span>
</span></pre></div>


            <div class="docstring"><p>Formats and tags a message from the environment, appending an identifier based on the turn number.
Updates the internal state with the latest environment response and its ID.
If the message is the last and <code><a href="#SelfContextClipCMT.force_think">force_think</a></code> is enabled, appends a prompt for further thinking.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>content (str):</strong>  The content of the message from the environment.</li>
<li><strong>turn (int):</strong>  The turn number of the message, must be in the range [0, 99).</li>
<li><strong>is_last (bool):</strong>  A flag indicating if this is the last message in the conversation.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>str: The formatted and tagged message content.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.post_tag_llm_message_context" class="classattr">
                                        <input id="SelfContextClipCMT.post_tag_llm_message_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">post_tag_llm_message_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">content</span>, </span><span class="param"><span class="n">turn</span>, </span><span class="param"><span class="n">is_last</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.post_tag_llm_message_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.post_tag_llm_message_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.post_tag_llm_message_context-138"><a href="#SelfContextClipCMT.post_tag_llm_message_context-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_tag_llm_message_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">is_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-139"><a href="#SelfContextClipCMT.post_tag_llm_message_context-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-140"><a href="#SelfContextClipCMT.post_tag_llm_message_context-140"><span class="linenos">140</span></a><span class="sd">        Formats the LLM&#39;s message by adding a specific tag and turn identifier.</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-141"><a href="#SelfContextClipCMT.post_tag_llm_message_context-141"><span class="linenos">141</span></a>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-142"><a href="#SelfContextClipCMT.post_tag_llm_message_context-142"><span class="linenos">142</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-143"><a href="#SelfContextClipCMT.post_tag_llm_message_context-143"><span class="linenos">143</span></a><span class="sd">            content (str): The content of the LLM&#39;s message.</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-144"><a href="#SelfContextClipCMT.post_tag_llm_message_context-144"><span class="linenos">144</span></a><span class="sd">            turn (int): The turn number of the message in the conversation.</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-145"><a href="#SelfContextClipCMT.post_tag_llm_message_context-145"><span class="linenos">145</span></a><span class="sd">            is_last (bool): A flag indicating if this is the last message in the conversation.</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-146"><a href="#SelfContextClipCMT.post_tag_llm_message_context-146"><span class="linenos">146</span></a>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-147"><a href="#SelfContextClipCMT.post_tag_llm_message_context-147"><span class="linenos">147</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-148"><a href="#SelfContextClipCMT.post_tag_llm_message_context-148"><span class="linenos">148</span></a><span class="sd">            str: The formatted message with the added tag and turn identifier.</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-149"><a href="#SelfContextClipCMT.post_tag_llm_message_context-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-150"><a href="#SelfContextClipCMT.post_tag_llm_message_context-150"><span class="linenos">150</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-151"><a href="#SelfContextClipCMT.post_tag_llm_message_context-151"><span class="linenos">151</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">is_last</span><span class="p">,</span> <span class="s2">&quot;llm message should never be last&quot;</span>  <span class="c1">#  Ensures the LLM&#39;s message is not the last in the conversation</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-152"><a href="#SelfContextClipCMT.post_tag_llm_message_context-152"><span class="linenos">152</span></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">,</span> <span class="s2">&quot;turn must be in the range [0, 99)&quot;</span>  <span class="c1">#  Validates the turn number is within the valid range</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-153"><a href="#SelfContextClipCMT.post_tag_llm_message_context-153"><span class="linenos">153</span></a>        <span class="n">turn_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">turn</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-154"><a href="#SelfContextClipCMT.post_tag_llm_message_context-154"><span class="linenos">154</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-155"><a href="#SelfContextClipCMT.post_tag_llm_message_context-155"><span class="linenos">155</span></a><span class="s2">            [Assistant Response, id=AR</span><span class="si">{</span><span class="n">turn_id</span><span class="si">}</span><span class="s2">]</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-156"><a href="#SelfContextClipCMT.post_tag_llm_message_context-156"><span class="linenos">156</span></a><span class="s2">            ---</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-157"><a href="#SelfContextClipCMT.post_tag_llm_message_context-157"><span class="linenos">157</span></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Adds the tag and turn identifier to the message</span>
</span><span id="SelfContextClipCMT.post_tag_llm_message_context-158"><a href="#SelfContextClipCMT.post_tag_llm_message_context-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="n">content</span>
</span></pre></div>


            <div class="docstring"><p>Formats the LLM's message by adding a specific tag and turn identifier.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>content (str):</strong>  The content of the LLM's message.</li>
<li><strong>turn (int):</strong>  The turn number of the message in the conversation.</li>
<li><strong>is_last (bool):</strong>  A flag indicating if this is the last message in the conversation.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>str: The formatted message with the added tag and turn identifier.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.strip_think_tags" class="classattr">
                                        <input id="SelfContextClipCMT.strip_think_tags-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">strip_think_tags</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">text</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.strip_think_tags-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.strip_think_tags"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.strip_think_tags-160"><a href="#SelfContextClipCMT.strip_think_tags-160"><span class="linenos">160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">strip_think_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.strip_think_tags-161"><a href="#SelfContextClipCMT.strip_think_tags-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.strip_think_tags-162"><a href="#SelfContextClipCMT.strip_think_tags-162"><span class="linenos">162</span></a><span class="sd">        Removes &lt;think&gt; and &lt;/think&gt; tags, along with their enclosed content, from the provided text.</span>
</span><span id="SelfContextClipCMT.strip_think_tags-163"><a href="#SelfContextClipCMT.strip_think_tags-163"><span class="linenos">163</span></a>
</span><span id="SelfContextClipCMT.strip_think_tags-164"><a href="#SelfContextClipCMT.strip_think_tags-164"><span class="linenos">164</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.strip_think_tags-165"><a href="#SelfContextClipCMT.strip_think_tags-165"><span class="linenos">165</span></a><span class="sd">            text (str): The input text containing &lt;think&gt; and &lt;/think&gt; tags.</span>
</span><span id="SelfContextClipCMT.strip_think_tags-166"><a href="#SelfContextClipCMT.strip_think_tags-166"><span class="linenos">166</span></a>
</span><span id="SelfContextClipCMT.strip_think_tags-167"><a href="#SelfContextClipCMT.strip_think_tags-167"><span class="linenos">167</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.strip_think_tags-168"><a href="#SelfContextClipCMT.strip_think_tags-168"><span class="linenos">168</span></a><span class="sd">            str: The text with all &lt;think&gt; and &lt;/think&gt; tags and their enclosed content removed.</span>
</span><span id="SelfContextClipCMT.strip_think_tags-169"><a href="#SelfContextClipCMT.strip_think_tags-169"><span class="linenos">169</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.strip_think_tags-170"><a href="#SelfContextClipCMT.strip_think_tags-170"><span class="linenos">170</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&lt;think\&gt;.*?\&lt;\/think\&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1">#  Remove content within &lt;think&gt; and &lt;/think&gt; tags</span>
</span><span id="SelfContextClipCMT.strip_think_tags-171"><a href="#SelfContextClipCMT.strip_think_tags-171"><span class="linenos">171</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">new_ext_msg_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove any remaining &lt;think&gt; tags</span>
</span><span id="SelfContextClipCMT.strip_think_tags-172"><a href="#SelfContextClipCMT.strip_think_tags-172"><span class="linenos">172</span></a>        <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="n">new_ext_msg_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Remove any remaining &lt;/think&gt; tags</span>
</span><span id="SelfContextClipCMT.strip_think_tags-173"><a href="#SelfContextClipCMT.strip_think_tags-173"><span class="linenos">173</span></a>        <span class="k">return</span> <span class="n">new_ext_msg_content</span>
</span></pre></div>


            <div class="docstring"><p>Removes <think> and </think> tags, along with their enclosed content, from the provided text.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>text (str):</strong>  The input text containing <think> and </think> tags.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>str: The text with all <think> and </think> tags and their enclosed content removed.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.prepare_next_llm_context" class="classattr">
                                        <input id="SelfContextClipCMT.prepare_next_llm_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prepare_next_llm_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.prepare_next_llm_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.prepare_next_llm_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.prepare_next_llm_context-175"><a href="#SelfContextClipCMT.prepare_next_llm_context-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_next_llm_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-176"><a href="#SelfContextClipCMT.prepare_next_llm_context-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-177"><a href="#SelfContextClipCMT.prepare_next_llm_context-177"><span class="linenos">177</span></a><span class="sd">        Prepares the next context for the LLM by filtering and processing the previous messages.</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-178"><a href="#SelfContextClipCMT.prepare_next_llm_context-178"><span class="linenos">178</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-179"><a href="#SelfContextClipCMT.prepare_next_llm_context-179"><span class="linenos">179</span></a><span class="sd">        This function filters out non-deprecated context, processes each message based on its author,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-180"><a href="#SelfContextClipCMT.prepare_next_llm_context-180"><span class="linenos">180</span></a><span class="sd">        and formats the context appropriately for the next LLM interaction.</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-181"><a href="#SelfContextClipCMT.prepare_next_llm_context-181"><span class="linenos">181</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-182"><a href="#SelfContextClipCMT.prepare_next_llm_context-182"><span class="linenos">182</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-183"><a href="#SelfContextClipCMT.prepare_next_llm_context-183"><span class="linenos">183</span></a><span class="sd">            list: A list of dictionaries representing the updated context.</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-184"><a href="#SelfContextClipCMT.prepare_next_llm_context-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-185"><a href="#SelfContextClipCMT.prepare_next_llm_context-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-186"><a href="#SelfContextClipCMT.prepare_next_llm_context-186"><span class="linenos">186</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-187"><a href="#SelfContextClipCMT.prepare_next_llm_context-187"><span class="linenos">187</span></a>        <span class="c1"># first we get all previous context (non-deprecated context)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-188"><a href="#SelfContextClipCMT.prepare_next_llm_context-188"><span class="linenos">188</span></a>        <span class="c1"># get `init_message -&gt; user -&gt; llm -&gt; user -&gt; llm`` or `init_message -&gt; llm -&gt; user -&gt; llm -&gt; user``</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-189"><a href="#SelfContextClipCMT.prepare_next_llm_context-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_context_via_authors</span><span class="p">([</span><span class="s2">&quot;initialization&quot;</span><span class="p">,</span> <span class="s2">&quot;llm&quot;</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">])</span>  <span class="c1">#  Filter the context to include only relevant authors</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-190"><a href="#SelfContextClipCMT.prepare_next_llm_context-190"><span class="linenos">190</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-191"><a href="#SelfContextClipCMT.prepare_next_llm_context-191"><span class="linenos">191</span></a>        <span class="n">env_turn</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-192"><a href="#SelfContextClipCMT.prepare_next_llm_context-192"><span class="linenos">192</span></a>        <span class="n">llm_turn</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-193"><a href="#SelfContextClipCMT.prepare_next_llm_context-193"><span class="linenos">193</span></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)):</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-194"><a href="#SelfContextClipCMT.prepare_next_llm_context-194"><span class="linenos">194</span></a>            <span class="n">is_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-195"><a href="#SelfContextClipCMT.prepare_next_llm_context-195"><span class="linenos">195</span></a>            <span class="c1"># Process according to message type</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-196"><a href="#SelfContextClipCMT.prepare_next_llm_context-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-197"><a href="#SelfContextClipCMT.prepare_next_llm_context-197"><span class="linenos">197</span></a>                <span class="c1"># If it&#39;s a previous llm message, remove think tags</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-198"><a href="#SelfContextClipCMT.prepare_next_llm_context-198"><span class="linenos">198</span></a>                <span class="n">new_ext_msg_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_think_tags</span><span class="p">(</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-199"><a href="#SelfContextClipCMT.prepare_next_llm_context-199"><span class="linenos">199</span></a>                <span class="n">author_override</span> <span class="o">=</span> <span class="s2">&quot;llm(do_not_train)&quot;</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-200"><a href="#SelfContextClipCMT.prepare_next_llm_context-200"><span class="linenos">200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-201"><a href="#SelfContextClipCMT.prepare_next_llm_context-201"><span class="linenos">201</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">author_override</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-202"><a href="#SelfContextClipCMT.prepare_next_llm_context-202"><span class="linenos">202</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-203"><a href="#SelfContextClipCMT.prepare_next_llm_context-203"><span class="linenos">203</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_llm_message_context</span><span class="p">(</span><span class="n">new_ext_msg_content</span><span class="p">,</span> <span class="n">turn</span><span class="o">=</span><span class="n">llm_turn</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-204"><a href="#SelfContextClipCMT.prepare_next_llm_context-204"><span class="linenos">204</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-205"><a href="#SelfContextClipCMT.prepare_next_llm_context-205"><span class="linenos">205</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-206"><a href="#SelfContextClipCMT.prepare_next_llm_context-206"><span class="linenos">206</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-207"><a href="#SelfContextClipCMT.prepare_next_llm_context-207"><span class="linenos">207</span></a>                <span class="p">)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-208"><a href="#SelfContextClipCMT.prepare_next_llm_context-208"><span class="linenos">208</span></a>                <span class="n">llm_turn</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-209"><a href="#SelfContextClipCMT.prepare_next_llm_context-209"><span class="linenos">209</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-210"><a href="#SelfContextClipCMT.prepare_next_llm_context-210"><span class="linenos">210</span></a>            <span class="c1"># process env message</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-211"><a href="#SelfContextClipCMT.prepare_next_llm_context-211"><span class="linenos">211</span></a>            <span class="k">elif</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-212"><a href="#SelfContextClipCMT.prepare_next_llm_context-212"><span class="linenos">212</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-213"><a href="#SelfContextClipCMT.prepare_next_llm_context-213"><span class="linenos">213</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-214"><a href="#SelfContextClipCMT.prepare_next_llm_context-214"><span class="linenos">214</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-215"><a href="#SelfContextClipCMT.prepare_next_llm_context-215"><span class="linenos">215</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_env_message_context</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">,</span> <span class="n">turn</span><span class="o">=</span><span class="n">env_turn</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-216"><a href="#SelfContextClipCMT.prepare_next_llm_context-216"><span class="linenos">216</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-217"><a href="#SelfContextClipCMT.prepare_next_llm_context-217"><span class="linenos">217</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-218"><a href="#SelfContextClipCMT.prepare_next_llm_context-218"><span class="linenos">218</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-219"><a href="#SelfContextClipCMT.prepare_next_llm_context-219"><span class="linenos">219</span></a>                <span class="p">)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-220"><a href="#SelfContextClipCMT.prepare_next_llm_context-220"><span class="linenos">220</span></a>                <span class="n">env_turn</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-221"><a href="#SelfContextClipCMT.prepare_next_llm_context-221"><span class="linenos">221</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-222"><a href="#SelfContextClipCMT.prepare_next_llm_context-222"><span class="linenos">222</span></a>            <span class="k">elif</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;initialization&quot;</span><span class="p">]:</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-223"><a href="#SelfContextClipCMT.prepare_next_llm_context-223"><span class="linenos">223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-224"><a href="#SelfContextClipCMT.prepare_next_llm_context-224"><span class="linenos">224</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-225"><a href="#SelfContextClipCMT.prepare_next_llm_context-225"><span class="linenos">225</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-226"><a href="#SelfContextClipCMT.prepare_next_llm_context-226"><span class="linenos">226</span></a>                    <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post_tag_init_message_context</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="n">is_last</span><span class="p">),</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-227"><a href="#SelfContextClipCMT.prepare_next_llm_context-227"><span class="linenos">227</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-228"><a href="#SelfContextClipCMT.prepare_next_llm_context-228"><span class="linenos">228</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-229"><a href="#SelfContextClipCMT.prepare_next_llm_context-229"><span class="linenos">229</span></a>                    <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-230"><a href="#SelfContextClipCMT.prepare_next_llm_context-230"><span class="linenos">230</span></a>                <span class="p">)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-231"><a href="#SelfContextClipCMT.prepare_next_llm_context-231"><span class="linenos">231</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-232"><a href="#SelfContextClipCMT.prepare_next_llm_context-232"><span class="linenos">232</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-233"><a href="#SelfContextClipCMT.prepare_next_llm_context-233"><span class="linenos">233</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown author </span><span class="si">{</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2"> in latest_llm_interaction_socket&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-234"><a href="#SelfContextClipCMT.prepare_next_llm_context-234"><span class="linenos">234</span></a>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-235"><a href="#SelfContextClipCMT.prepare_next_llm_context-235"><span class="linenos">235</span></a>        <span class="n">listofdict_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_role_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span><span class="p">)</span>  <span class="c1">#  Convert the processed context to a list of dictionaries</span>
</span><span id="SelfContextClipCMT.prepare_next_llm_context-236"><a href="#SelfContextClipCMT.prepare_next_llm_context-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">listofdict_context</span>
</span></pre></div>


            <div class="docstring"><p>Prepares the next context for the LLM by filtering and processing the previous messages.</p>

<p>This function filters out non-deprecated context, processes each message based on its author,
and formats the context appropriately for the next LLM interaction.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>list: A list of dictionaries representing the updated context.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.save_init_input" class="classattr">
                                        <input id="SelfContextClipCMT.save_init_input-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_init_input</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">init_input_arr</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">add_nothink</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.save_init_input-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.save_init_input"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.save_init_input-239"><a href="#SelfContextClipCMT.save_init_input-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_init_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_input_arr</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_nothink</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.save_init_input-240"><a href="#SelfContextClipCMT.save_init_input-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.save_init_input-241"><a href="#SelfContextClipCMT.save_init_input-241"><span class="linenos">241</span></a><span class="sd">        Saves the initial input array by calling the parent class&#39;s method.</span>
</span><span id="SelfContextClipCMT.save_init_input-242"><a href="#SelfContextClipCMT.save_init_input-242"><span class="linenos">242</span></a>
</span><span id="SelfContextClipCMT.save_init_input-243"><a href="#SelfContextClipCMT.save_init_input-243"><span class="linenos">243</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.save_init_input-244"><a href="#SelfContextClipCMT.save_init_input-244"><span class="linenos">244</span></a><span class="sd">            init_input_arr (list): The initial input array to be saved.</span>
</span><span id="SelfContextClipCMT.save_init_input-245"><a href="#SelfContextClipCMT.save_init_input-245"><span class="linenos">245</span></a><span class="sd">            add_nothink: Additional parameter passed to the parent method.</span>
</span><span id="SelfContextClipCMT.save_init_input-246"><a href="#SelfContextClipCMT.save_init_input-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.save_init_input-247"><a href="#SelfContextClipCMT.save_init_input-247"><span class="linenos">247</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save_init_input</span><span class="p">(</span><span class="n">init_input_arr</span><span class="p">,</span> <span class="n">add_nothink</span><span class="p">)</span>  <span class="c1">#  Calls the parent class&#39;s method to save the initial input</span>
</span><span id="SelfContextClipCMT.save_init_input-248"><a href="#SelfContextClipCMT.save_init_input-248"><span class="linenos">248</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Saves the initial input array by calling the parent class's method.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>init_input_arr (list):</strong>  The initial input array to be saved.</li>
<li><strong>add_nothink:</strong>  Additional parameter passed to the parent method.</li>
</ul>
</div>


                            </div>
                            <div id="SelfContextClipCMT.impl_new_request_from_previous_interaction" class="classattr">
                                        <input id="SelfContextClipCMT.impl_new_request_from_previous_interaction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">impl_new_request_from_previous_interaction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_message</span>, </span><span class="param"><span class="n">this_interaction</span>, </span><span class="param"><span class="n">strip_think</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.impl_new_request_from_previous_interaction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.impl_new_request_from_previous_interaction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-251"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-251"><span class="linenos">251</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">impl_new_request_from_previous_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_message</span><span class="p">,</span>  <span class="n">this_interaction</span><span class="p">,</span> <span class="n">strip_think</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-252"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-253"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-253"><span class="linenos">253</span></a><span class="sd">        Processes a new request in the context of previous interactions, optionally stripping &#39;think&#39; tags,</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-254"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-254"><span class="linenos">254</span></a><span class="sd">        and generates a new LLM response based on the updated context.</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-255"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-255"><span class="linenos">255</span></a>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-256"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-256"><span class="linenos">256</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-257"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-257"><span class="linenos">257</span></a><span class="sd">            new_message: The new message to be added to the interaction.</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-258"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-258"><span class="linenos">258</span></a><span class="sd">            this_interaction: The list of previous interactions.</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-259"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-259"><span class="linenos">259</span></a><span class="sd">            strip_think (bool, optional): Whether to strip &#39;think&#39; tags from the messages. Defaults to False.</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-260"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-260"><span class="linenos">260</span></a>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-261"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-261"><span class="linenos">261</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-262"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-262"><span class="linenos">262</span></a><span class="sd">            tuple: A tuple containing the updated interaction list and the LLM&#39;s output content.</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-263"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-263"><span class="linenos">263</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-264"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-264"><span class="linenos">264</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-265"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">strip_think</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-266"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-266"><span class="linenos">266</span></a>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-267"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-267"><span class="linenos">267</span></a>                <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm(do_not_train)&quot;</span> <span class="ow">or</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="s2">&quot;llm&quot;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-268"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-268"><span class="linenos">268</span></a>                    <span class="n">latest_llm_interaction_socket_additional</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-269"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-269"><span class="linenos">269</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-270"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-270"><span class="linenos">270</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-271"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-271"><span class="linenos">271</span></a>                        <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strip_think_tags</span><span class="p">(</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-272"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-272"><span class="linenos">272</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-273"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-273"><span class="linenos">273</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-274"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-274"><span class="linenos">274</span></a>                        <span class="n">build_from_uuid</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span> <span class="k">if</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span> <span class="k">else</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-275"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-275"><span class="linenos">275</span></a>                    <span class="p">)</span>  <span class="c1">#  Strips &#39;think&#39; tags from the message content</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-276"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-276"><span class="linenos">276</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-277"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-277"><span class="linenos">277</span></a>                    <span class="k">continue</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-278"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-278"><span class="linenos">278</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_message</span><span class="p">]</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-279"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-279"><span class="linenos">279</span></a>        <span class="n">dict_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_role_content</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-280"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-281"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-281"><span class="linenos">281</span></a>            <span class="n">llm_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_chat_fn</span><span class="p">(</span><span class="n">dict_context</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1">#  Generates LLM output using the current model</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-282"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-282"><span class="linenos">282</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-283"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-283"><span class="linenos">283</span></a>            <span class="n">llm_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alien_llm_chat_fn</span><span class="p">(</span><span class="n">dict_context</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1">#  Generates LLM output using an external model</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-284"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-284"><span class="linenos">284</span></a>        <span class="n">latest_llm_interaction_socket_additional</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_llm_output_do_not_register_full_context</span><span class="p">(</span><span class="n">llm_output</span><span class="p">,</span> <span class="n">dict_context</span><span class="p">)]</span>  <span class="c1">#  Adds the LLM output to the interaction history</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-285"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sp_action</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-286"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-286"><span class="linenos">286</span></a>            <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">latest_llm_interaction_socket_additional</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-287"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-287"><span class="linenos">287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grouped_steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">this_interaction</span><span class="p">]</span>  <span class="c1">#  Updates the grouped steps with the latest interaction</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-288"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console_debug_mode</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-289"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-289"><span class="linenos">289</span></a>            <span class="n">print_listofdict</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-290"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-290"><span class="linenos">290</span></a>                <span class="n">dict_context</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;llm_latest&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}],</span> <span class="n">mod</span><span class="o">=</span><span class="s1">&#39;c&#39;</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-291"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-291"><span class="linenos">291</span></a>            <span class="p">)</span>  <span class="c1">#  Prints the updated context and LLM output to the console</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-292"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-292"><span class="linenos">292</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-293"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-293"><span class="linenos">293</span></a>            <span class="n">print_listofdict</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-294"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-294"><span class="linenos">294</span></a>                <span class="n">dict_context</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;llm_latest&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]}],</span> <span class="n">mod</span><span class="o">=</span><span class="s1">&#39;env_clip&#39;</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-295"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-295"><span class="linenos">295</span></a>            <span class="p">)</span>  <span class="c1">#  Logs the updated context and LLM output to a file</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-296"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-296"><span class="linenos">296</span></a>        <span class="n">output_llm_content</span> <span class="o">=</span> <span class="n">llm_output</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT.impl_new_request_from_previous_interaction-297"><a href="#SelfContextClipCMT.impl_new_request_from_previous_interaction-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">latest_llm_interaction_socket_additional</span><span class="p">,</span> <span class="n">output_llm_content</span>
</span></pre></div>


            <div class="docstring"><p>Processes a new request in the context of previous interactions, optionally stripping 'think' tags,
and generates a new LLM response based on the updated context.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>new_message:</strong>  The new message to be added to the interaction.</li>
<li><strong>this_interaction:</strong>  The list of previous interactions.</li>
<li><strong>strip_think (bool, optional):</strong>  Whether to strip 'think' tags from the messages. Defaults to False.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple: A tuple containing the updated interaction list and the LLM's output content.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.after_save_llm_output" class="classattr">
                                        <input id="SelfContextClipCMT.after_save_llm_output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">after_save_llm_output</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">this_interaction</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.after_save_llm_output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.after_save_llm_output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.after_save_llm_output-300"><a href="#SelfContextClipCMT.after_save_llm_output-300"><span class="linenos">300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">after_save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">this_interaction</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-301"><a href="#SelfContextClipCMT.after_save_llm_output-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-302"><a href="#SelfContextClipCMT.after_save_llm_output-302"><span class="linenos">302</span></a><span class="sd">        this_interaction = [</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-303"><a href="#SelfContextClipCMT.after_save_llm_output-303"><span class="linenos">303</span></a><span class="sd">            init msg,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-304"><a href="#SelfContextClipCMT.after_save_llm_output-304"><span class="linenos">304</span></a><span class="sd">            ...,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-305"><a href="#SelfContextClipCMT.after_save_llm_output-305"><span class="linenos">305</span></a><span class="sd">            init msg,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-306"><a href="#SelfContextClipCMT.after_save_llm_output-306"><span class="linenos">306</span></a><span class="sd">            ...</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-307"><a href="#SelfContextClipCMT.after_save_llm_output-307"><span class="linenos">307</span></a><span class="sd">            previous env msg,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-308"><a href="#SelfContextClipCMT.after_save_llm_output-308"><span class="linenos">308</span></a><span class="sd">            latest llm msg,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-309"><a href="#SelfContextClipCMT.after_save_llm_output-309"><span class="linenos">309</span></a><span class="sd">        ]</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-310"><a href="#SelfContextClipCMT.after_save_llm_output-310"><span class="linenos">310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-311"><a href="#SelfContextClipCMT.after_save_llm_output-311"><span class="linenos">311</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-312"><a href="#SelfContextClipCMT.after_save_llm_output-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_env_response_id</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-313"><a href="#SelfContextClipCMT.after_save_llm_output-313"><span class="linenos">313</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-314"><a href="#SelfContextClipCMT.after_save_llm_output-314"><span class="linenos">314</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-315"><a href="#SelfContextClipCMT.after_save_llm_output-315"><span class="linenos">315</span></a>        <span class="n">clip_token_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">context_template_clip_trigger_token_num</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-316"><a href="#SelfContextClipCMT.after_save_llm_output-316"><span class="linenos">316</span></a>        <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-317"><a href="#SelfContextClipCMT.after_save_llm_output-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_seq_length</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">clip_token_cnt</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-318"><a href="#SelfContextClipCMT.after_save_llm_output-318"><span class="linenos">318</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-319"><a href="#SelfContextClipCMT.after_save_llm_output-319"><span class="linenos">319</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-320"><a href="#SelfContextClipCMT.after_save_llm_output-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-321"><a href="#SelfContextClipCMT.after_save_llm_output-321"><span class="linenos">321</span></a>            <span class="k">return</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-322"><a href="#SelfContextClipCMT.after_save_llm_output-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clipped_before</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-323"><a href="#SelfContextClipCMT.after_save_llm_output-323"><span class="linenos">323</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-324"><a href="#SelfContextClipCMT.after_save_llm_output-324"><span class="linenos">324</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">generated_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl_new_request_from_previous_interaction</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-325"><a href="#SelfContextClipCMT.after_save_llm_output-325"><span class="linenos">325</span></a>            <span class="n">new_message</span><span class="o">=</span><span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-326"><a href="#SelfContextClipCMT.after_save_llm_output-326"><span class="linenos">326</span></a>                <span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-327"><a href="#SelfContextClipCMT.after_save_llm_output-327"><span class="linenos">327</span></a>                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-328"><a href="#SelfContextClipCMT.after_save_llm_output-328"><span class="linenos">328</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-329"><a href="#SelfContextClipCMT.after_save_llm_output-329"><span class="linenos">329</span></a><span class="s2">                    Your new task is to inspect each `Environment Response` and `Assistant Response` messages,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-330"><a href="#SelfContextClipCMT.after_save_llm_output-330"><span class="linenos">330</span></a><span class="s2">                    and determine whether each message is useful for the next-step decision-making.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-331"><a href="#SelfContextClipCMT.after_save_llm_output-331"><span class="linenos">331</span></a><span class="s2">                    Generate a json structure following the format below:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-332"><a href="#SelfContextClipCMT.after_save_llm_output-332"><span class="linenos">332</span></a><span class="s2">                    ```json</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-333"><a href="#SelfContextClipCMT.after_save_llm_output-333"><span class="linenos">333</span></a><span class="s2">                    [</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-334"><a href="#SelfContextClipCMT.after_save_llm_output-334"><span class="linenos">334</span></a><span class="s2">                        {&quot;id&quot;:&quot;ARXXX or ERXXX&quot;, &quot;useful&quot;:true or false, &quot;action&quot;: &quot;keep or remove or compress&quot;},</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-335"><a href="#SelfContextClipCMT.after_save_llm_output-335"><span class="linenos">335</span></a><span class="s2">                        ...,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-336"><a href="#SelfContextClipCMT.after_save_llm_output-336"><span class="linenos">336</span></a><span class="s2">                        {&quot;id&quot;:&quot;ARXXX or ERXXX&quot;, &quot;useful&quot;:true or false, &quot;action&quot;: &quot;keep or remove or compress&quot;},</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-337"><a href="#SelfContextClipCMT.after_save_llm_output-337"><span class="linenos">337</span></a><span class="s2">                    ]</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-338"><a href="#SelfContextClipCMT.after_save_llm_output-338"><span class="linenos">338</span></a><span class="s2">                    ```</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-339"><a href="#SelfContextClipCMT.after_save_llm_output-339"><span class="linenos">339</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-340"><a href="#SelfContextClipCMT.after_save_llm_output-340"><span class="linenos">340</span></a><span class="s2">                    For example:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-341"><a href="#SelfContextClipCMT.after_save_llm_output-341"><span class="linenos">341</span></a><span class="s2">                    ```json</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-342"><a href="#SelfContextClipCMT.after_save_llm_output-342"><span class="linenos">342</span></a><span class="s2">                    [</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-343"><a href="#SelfContextClipCMT.after_save_llm_output-343"><span class="linenos">343</span></a><span class="s2">                        {&quot;id&quot;:&quot;ER001&quot;, &quot;useful&quot;:true, &quot;action&quot;: &quot;keep&quot;},</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-344"><a href="#SelfContextClipCMT.after_save_llm_output-344"><span class="linenos">344</span></a><span class="s2">                        {&quot;id&quot;:&quot;AR001&quot;, &quot;useful&quot;:false, &quot;action&quot;: &quot;remove&quot;},</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-345"><a href="#SelfContextClipCMT.after_save_llm_output-345"><span class="linenos">345</span></a><span class="s2">                        ...</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-346"><a href="#SelfContextClipCMT.after_save_llm_output-346"><span class="linenos">346</span></a><span class="s2">                    ]</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-347"><a href="#SelfContextClipCMT.after_save_llm_output-347"><span class="linenos">347</span></a><span class="s2">                    ```</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-348"><a href="#SelfContextClipCMT.after_save_llm_output-348"><span class="linenos">348</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-349"><a href="#SelfContextClipCMT.after_save_llm_output-349"><span class="linenos">349</span></a><span class="s2">                    Rules:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-350"><a href="#SelfContextClipCMT.after_save_llm_output-350"><span class="linenos">350</span></a><span class="s2">                    - If the message contains useful information for future decisions, set &quot;useful&quot;:true and &quot;action&quot;:&quot;keep&quot;.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-351"><a href="#SelfContextClipCMT.after_save_llm_output-351"><span class="linenos">351</span></a><span class="s2">                    - If the message records important previous action or environment feedback, set &quot;useful&quot;:true and &quot;action&quot;:&quot;keep&quot;.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-352"><a href="#SelfContextClipCMT.after_save_llm_output-352"><span class="linenos">352</span></a><span class="s2">                    - If the message is very long and very redundant, set &quot;useful&quot;:true and &quot;action&quot;:&quot;compress&quot;.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-353"><a href="#SelfContextClipCMT.after_save_llm_output-353"><span class="linenos">353</span></a><span class="s2">                    - If the message is completely irrelevant, set &quot;useful&quot;:false and &quot;action&quot;:&quot;remove&quot;. Note that important failures should be preserved, because learning from past is vital.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-354"><a href="#SelfContextClipCMT.after_save_llm_output-354"><span class="linenos">354</span></a><span class="s2">                    - Ignore messages without id=XXX tags, where XXX is a 3-digit number.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-355"><a href="#SelfContextClipCMT.after_save_llm_output-355"><span class="linenos">355</span></a><span class="s2">                    - Ensure the JSON is properly formatted and valid.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-356"><a href="#SelfContextClipCMT.after_save_llm_output-356"><span class="linenos">356</span></a><span class="s2">                    - Remove or compress at least one message, because token limit is already reached.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-357"><a href="#SelfContextClipCMT.after_save_llm_output-357"><span class="linenos">357</span></a><span class="s2">                    - At least remove (or compress) one message.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-358"><a href="#SelfContextClipCMT.after_save_llm_output-358"><span class="linenos">358</span></a><span class="s2">                    - There must be no more than 2 &quot;compress&quot; actions in total, because &quot;compress&quot; action will cost considerable amount of time.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-359"><a href="#SelfContextClipCMT.after_save_llm_output-359"><span class="linenos">359</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-360"><a href="#SelfContextClipCMT.after_save_llm_output-360"><span class="linenos">360</span></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">),</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-361"><a href="#SelfContextClipCMT.after_save_llm_output-361"><span class="linenos">361</span></a>                <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-362"><a href="#SelfContextClipCMT.after_save_llm_output-362"><span class="linenos">362</span></a>                <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-363"><a href="#SelfContextClipCMT.after_save_llm_output-363"><span class="linenos">363</span></a>            <span class="p">),</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-364"><a href="#SelfContextClipCMT.after_save_llm_output-364"><span class="linenos">364</span></a>            <span class="n">this_interaction</span><span class="o">=</span><span class="n">this_interaction</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-365"><a href="#SelfContextClipCMT.after_save_llm_output-365"><span class="linenos">365</span></a>            <span class="n">strip_think</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-366"><a href="#SelfContextClipCMT.after_save_llm_output-366"><span class="linenos">366</span></a>        <span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-367"><a href="#SelfContextClipCMT.after_save_llm_output-367"><span class="linenos">367</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-368"><a href="#SelfContextClipCMT.after_save_llm_output-368"><span class="linenos">368</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-369"><a href="#SelfContextClipCMT.after_save_llm_output-369"><span class="linenos">369</span></a>            <span class="n">llm_output_content</span> <span class="o">=</span> <span class="n">generated_content</span> <span class="o">=</span> <span class="n">generated_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-370"><a href="#SelfContextClipCMT.after_save_llm_output-370"><span class="linenos">370</span></a>            <span class="k">if</span> <span class="n">llm_output_content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-371"><a href="#SelfContextClipCMT.after_save_llm_output-371"><span class="linenos">371</span></a>                <span class="n">extracted_content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">llm_output_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-372"><a href="#SelfContextClipCMT.after_save_llm_output-372"><span class="linenos">372</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-373"><a href="#SelfContextClipCMT.after_save_llm_output-373"><span class="linenos">373</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find ``` in llm_output content: </span><span class="si">{</span><span class="n">llm_output_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-374"><a href="#SelfContextClipCMT.after_save_llm_output-374"><span class="linenos">374</span></a>            <span class="k">if</span> <span class="n">extracted_content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-375"><a href="#SelfContextClipCMT.after_save_llm_output-375"><span class="linenos">375</span></a>                <span class="n">extracted_content</span> <span class="o">=</span> <span class="n">extracted_content</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-376"><a href="#SelfContextClipCMT.after_save_llm_output-376"><span class="linenos">376</span></a>            <span class="n">extracted_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-377"><a href="#SelfContextClipCMT.after_save_llm_output-377"><span class="linenos">377</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">extracted_json</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-378"><a href="#SelfContextClipCMT.after_save_llm_output-378"><span class="linenos">378</span></a>                <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="s1">&#39;useful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="s1">&#39;action&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-379"><a href="#SelfContextClipCMT.after_save_llm_output-379"><span class="linenos">379</span></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each item must contain &#39;id&#39;, &#39;useful&#39;, and &#39;action&#39; fields. Error in item: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-380"><a href="#SelfContextClipCMT.after_save_llm_output-380"><span class="linenos">380</span></a>                <span class="n">message_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-381"><a href="#SelfContextClipCMT.after_save_llm_output-381"><span class="linenos">381</span></a>                <span class="n">message_action</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-382"><a href="#SelfContextClipCMT.after_save_llm_output-382"><span class="linenos">382</span></a>                <span class="c1"># find message from self.full_context</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-383"><a href="#SelfContextClipCMT.after_save_llm_output-383"><span class="linenos">383</span></a>                <span class="c1">## match latest_llm_interaction_socket_additional and match self.full_context</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-384"><a href="#SelfContextClipCMT.after_save_llm_output-384"><span class="linenos">384</span></a>                <span class="n">from_uuid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-385"><a href="#SelfContextClipCMT.after_save_llm_output-385"><span class="linenos">385</span></a>                <span class="k">for</span> <span class="n">ext_msg</span> <span class="ow">in</span> <span class="n">this_interaction</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-386"><a href="#SelfContextClipCMT.after_save_llm_output-386"><span class="linenos">386</span></a>                    <span class="k">if</span> <span class="n">message_id</span> <span class="ow">in</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-387"><a href="#SelfContextClipCMT.after_save_llm_output-387"><span class="linenos">387</span></a>                        <span class="n">from_uuid</span> <span class="o">=</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">build_from_uuid</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-388"><a href="#SelfContextClipCMT.after_save_llm_output-388"><span class="linenos">388</span></a>                        <span class="k">break</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-389"><a href="#SelfContextClipCMT.after_save_llm_output-389"><span class="linenos">389</span></a>                <span class="k">if</span> <span class="n">from_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-390"><a href="#SelfContextClipCMT.after_save_llm_output-390"><span class="linenos">390</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find message_id </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> in `this_interaction`&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-391"><a href="#SelfContextClipCMT.after_save_llm_output-391"><span class="linenos">391</span></a>                <span class="n">target_msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-392"><a href="#SelfContextClipCMT.after_save_llm_output-392"><span class="linenos">392</span></a>                <span class="n">target_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-393"><a href="#SelfContextClipCMT.after_save_llm_output-393"><span class="linenos">393</span></a>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-394"><a href="#SelfContextClipCMT.after_save_llm_output-394"><span class="linenos">394</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">from_uuid</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-395"><a href="#SelfContextClipCMT.after_save_llm_output-395"><span class="linenos">395</span></a>                        <span class="n">target_msg</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-396"><a href="#SelfContextClipCMT.after_save_llm_output-396"><span class="linenos">396</span></a>                        <span class="n">target_index</span> <span class="o">=</span> <span class="n">index</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-397"><a href="#SelfContextClipCMT.after_save_llm_output-397"><span class="linenos">397</span></a>                        <span class="k">break</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-398"><a href="#SelfContextClipCMT.after_save_llm_output-398"><span class="linenos">398</span></a>                <span class="k">if</span> <span class="n">target_msg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-399"><a href="#SelfContextClipCMT.after_save_llm_output-399"><span class="linenos">399</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find message_id </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> in full_context&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-400"><a href="#SelfContextClipCMT.after_save_llm_output-400"><span class="linenos">400</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-401"><a href="#SelfContextClipCMT.after_save_llm_output-401"><span class="linenos">401</span></a>                <span class="c1">## take actions</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-402"><a href="#SelfContextClipCMT.after_save_llm_output-402"><span class="linenos">402</span></a>                <span class="k">if</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-403"><a href="#SelfContextClipCMT.after_save_llm_output-403"><span class="linenos">403</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-404"><a href="#SelfContextClipCMT.after_save_llm_output-404"><span class="linenos">404</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">author</span><span class="o">+</span><span class="s2">&quot;(discard)&quot;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-405"><a href="#SelfContextClipCMT.after_save_llm_output-405"><span class="linenos">405</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-406"><a href="#SelfContextClipCMT.after_save_llm_output-406"><span class="linenos">406</span></a>                        <span class="n">content</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>  <span class="c1"># keep original content</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-407"><a href="#SelfContextClipCMT.after_save_llm_output-407"><span class="linenos">407</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-408"><a href="#SelfContextClipCMT.after_save_llm_output-408"><span class="linenos">408</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-409"><a href="#SelfContextClipCMT.after_save_llm_output-409"><span class="linenos">409</span></a>                    <span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-410"><a href="#SelfContextClipCMT.after_save_llm_output-410"><span class="linenos">410</span></a>                <span class="k">elif</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;compress&#39;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-411"><a href="#SelfContextClipCMT.after_save_llm_output-411"><span class="linenos">411</span></a>                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">message_id</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-412"><a href="#SelfContextClipCMT.after_save_llm_output-412"><span class="linenos">412</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">generated_compressed_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl_new_request_from_previous_interaction</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-413"><a href="#SelfContextClipCMT.after_save_llm_output-413"><span class="linenos">413</span></a>                        <span class="n">new_message</span><span class="o">=</span><span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-414"><a href="#SelfContextClipCMT.after_save_llm_output-414"><span class="linenos">414</span></a>                            <span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-415"><a href="#SelfContextClipCMT.after_save_llm_output-415"><span class="linenos">415</span></a>                            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-416"><a href="#SelfContextClipCMT.after_save_llm_output-416"><span class="linenos">416</span></a>                            <span class="n">content</span><span class="o">=</span><span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-417"><a href="#SelfContextClipCMT.after_save_llm_output-417"><span class="linenos">417</span></a><span class="s2">                                Your new task is to inspect </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">, and filter out all redundant information, and only keep the most important information that is useful for future decision-making.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-418"><a href="#SelfContextClipCMT.after_save_llm_output-418"><span class="linenos">418</span></a><span class="s2">                                For example, if the content is a long text with multiple paragraphs, you should only preseve the key paragraphs and use ... to replace the rest.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-419"><a href="#SelfContextClipCMT.after_save_llm_output-419"><span class="linenos">419</span></a><span class="s2">                                If the content is a long list of data / dict / json, you should only preseve the key items and use ... to replace the rest.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-420"><a href="#SelfContextClipCMT.after_save_llm_output-420"><span class="linenos">420</span></a><span class="s2">                                Be careful to preserve all information that might be useful in the future. You should at least reduce 50% of </span><span class="si">{</span><span class="n">target_id</span><span class="si">}</span><span class="s2">.</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-421"><a href="#SelfContextClipCMT.after_save_llm_output-421"><span class="linenos">421</span></a><span class="s2">                                Remember wrap your answer with ```</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-422"><a href="#SelfContextClipCMT.after_save_llm_output-422"><span class="linenos">422</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-423"><a href="#SelfContextClipCMT.after_save_llm_output-423"><span class="linenos">423</span></a><span class="s2">                                Your response should be like:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-424"><a href="#SelfContextClipCMT.after_save_llm_output-424"><span class="linenos">424</span></a><span class="s2">                                ```</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-425"><a href="#SelfContextClipCMT.after_save_llm_output-425"><span class="linenos">425</span></a><span class="s2">                                ...content after filtering...</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-426"><a href="#SelfContextClipCMT.after_save_llm_output-426"><span class="linenos">426</span></a><span class="s2">                                ```</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-427"><a href="#SelfContextClipCMT.after_save_llm_output-427"><span class="linenos">427</span></a><span class="s2">                            &quot;&quot;&quot;</span><span class="p">),</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-428"><a href="#SelfContextClipCMT.after_save_llm_output-428"><span class="linenos">428</span></a>                            <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-429"><a href="#SelfContextClipCMT.after_save_llm_output-429"><span class="linenos">429</span></a>                            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-430"><a href="#SelfContextClipCMT.after_save_llm_output-430"><span class="linenos">430</span></a>                        <span class="p">),</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-431"><a href="#SelfContextClipCMT.after_save_llm_output-431"><span class="linenos">431</span></a>                        <span class="n">this_interaction</span><span class="o">=</span><span class="n">this_interaction</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># exclude the latest llm message</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-432"><a href="#SelfContextClipCMT.after_save_llm_output-432"><span class="linenos">432</span></a>                        <span class="n">strip_think</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-433"><a href="#SelfContextClipCMT.after_save_llm_output-433"><span class="linenos">433</span></a>                    <span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-434"><a href="#SelfContextClipCMT.after_save_llm_output-434"><span class="linenos">434</span></a>                    <span class="k">if</span> <span class="n">generated_compressed_content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-435"><a href="#SelfContextClipCMT.after_save_llm_output-435"><span class="linenos">435</span></a>                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find ``` in llm_output content: </span><span class="si">{</span><span class="n">generated_compressed_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-436"><a href="#SelfContextClipCMT.after_save_llm_output-436"><span class="linenos">436</span></a>                    <span class="n">compressed_content</span> <span class="o">=</span> <span class="n">generated_compressed_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-437"><a href="#SelfContextClipCMT.after_save_llm_output-437"><span class="linenos">437</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-438"><a href="#SelfContextClipCMT.after_save_llm_output-438"><span class="linenos">438</span></a>                        <span class="n">author</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-439"><a href="#SelfContextClipCMT.after_save_llm_output-439"><span class="linenos">439</span></a>                        <span class="n">role</span><span class="o">=</span><span class="n">target_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-440"><a href="#SelfContextClipCMT.after_save_llm_output-440"><span class="linenos">440</span></a>                        <span class="n">content</span><span class="o">=</span><span class="n">compressed_content</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-441"><a href="#SelfContextClipCMT.after_save_llm_output-441"><span class="linenos">441</span></a>                        <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-442"><a href="#SelfContextClipCMT.after_save_llm_output-442"><span class="linenos">442</span></a>                        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-443"><a href="#SelfContextClipCMT.after_save_llm_output-443"><span class="linenos">443</span></a>                    <span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-444"><a href="#SelfContextClipCMT.after_save_llm_output-444"><span class="linenos">444</span></a>                <span class="k">elif</span> <span class="n">message_action</span> <span class="o">==</span> <span class="s1">&#39;keep&#39;</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-445"><a href="#SelfContextClipCMT.after_save_llm_output-445"><span class="linenos">445</span></a>                    <span class="k">continue</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-446"><a href="#SelfContextClipCMT.after_save_llm_output-446"><span class="linenos">446</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-447"><a href="#SelfContextClipCMT.after_save_llm_output-447"><span class="linenos">447</span></a>                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action </span><span class="si">{</span><span class="n">message_action</span><span class="si">}</span><span class="s2">, must be one of [&#39;remove&#39;, &#39;keep&#39;, &#39;compress&#39;]&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-448"><a href="#SelfContextClipCMT.after_save_llm_output-448"><span class="linenos">448</span></a>
</span><span id="SelfContextClipCMT.after_save_llm_output-449"><a href="#SelfContextClipCMT.after_save_llm_output-449"><span class="linenos">449</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-450"><a href="#SelfContextClipCMT.after_save_llm_output-450"><span class="linenos">450</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing llm_output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-451"><a href="#SelfContextClipCMT.after_save_llm_output-451"><span class="linenos">451</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing llm_output&quot;</span><span class="p">)</span>
</span><span id="SelfContextClipCMT.after_save_llm_output-452"><a href="#SelfContextClipCMT.after_save_llm_output-452"><span class="linenos">452</span></a>            <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>this_interaction = [
    init msg,
    ...,
    init msg,
    ...
    previous env msg,
    latest llm msg,
]</p>
</div>


                            </div>
                            <div id="SelfContextClipCMT.replace_full_context_item" class="classattr">
                                        <input id="SelfContextClipCMT.replace_full_context_item-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">replace_full_context_item</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">match_content</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.replace_full_context_item-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.replace_full_context_item"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.replace_full_context_item-455"><a href="#SelfContextClipCMT.replace_full_context_item-455"><span class="linenos">455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">replace_full_context_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-456"><a href="#SelfContextClipCMT.replace_full_context_item-456"><span class="linenos">456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-457"><a href="#SelfContextClipCMT.replace_full_context_item-457"><span class="linenos">457</span></a><span class="sd">        Replaces the content of a message in the full context with new content if the match content is found.</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-458"><a href="#SelfContextClipCMT.replace_full_context_item-458"><span class="linenos">458</span></a>
</span><span id="SelfContextClipCMT.replace_full_context_item-459"><a href="#SelfContextClipCMT.replace_full_context_item-459"><span class="linenos">459</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-460"><a href="#SelfContextClipCMT.replace_full_context_item-460"><span class="linenos">460</span></a><span class="sd">            match_content (str): The content to search for in the full context.</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-461"><a href="#SelfContextClipCMT.replace_full_context_item-461"><span class="linenos">461</span></a><span class="sd">            new_content (str): The new content to replace the matched content with.</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-462"><a href="#SelfContextClipCMT.replace_full_context_item-462"><span class="linenos">462</span></a>
</span><span id="SelfContextClipCMT.replace_full_context_item-463"><a href="#SelfContextClipCMT.replace_full_context_item-463"><span class="linenos">463</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-464"><a href="#SelfContextClipCMT.replace_full_context_item-464"><span class="linenos">464</span></a><span class="sd">            bool: True if the replacement was successful, False otherwise.</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-465"><a href="#SelfContextClipCMT.replace_full_context_item-465"><span class="linenos">465</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-466"><a href="#SelfContextClipCMT.replace_full_context_item-466"><span class="linenos">466</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-467"><a href="#SelfContextClipCMT.replace_full_context_item-467"><span class="linenos">467</span></a>        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">)):</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-468"><a href="#SelfContextClipCMT.replace_full_context_item-468"><span class="linenos">468</span></a>            <span class="n">ext_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-469"><a href="#SelfContextClipCMT.replace_full_context_item-469"><span class="linenos">469</span></a>            <span class="k">if</span> <span class="n">match_content</span> <span class="ow">in</span> <span class="n">ext_msg</span><span class="o">.</span><span class="n">content_for_future</span><span class="p">:</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-470"><a href="#SelfContextClipCMT.replace_full_context_item-470"><span class="linenos">470</span></a>                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-471"><a href="#SelfContextClipCMT.replace_full_context_item-471"><span class="linenos">471</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">full_context</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExtendedMessage</span><span class="p">(</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-472"><a href="#SelfContextClipCMT.replace_full_context_item-472"><span class="linenos">472</span></a>                    <span class="n">author</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-473"><a href="#SelfContextClipCMT.replace_full_context_item-473"><span class="linenos">473</span></a>                    <span class="n">role</span><span class="o">=</span><span class="n">ext_msg</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-474"><a href="#SelfContextClipCMT.replace_full_context_item-474"><span class="linenos">474</span></a>                    <span class="n">content</span><span class="o">=</span><span class="n">new_content</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-475"><a href="#SelfContextClipCMT.replace_full_context_item-475"><span class="linenos">475</span></a>                    <span class="n">token_generator</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-476"><a href="#SelfContextClipCMT.replace_full_context_item-476"><span class="linenos">476</span></a>                    <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-477"><a href="#SelfContextClipCMT.replace_full_context_item-477"><span class="linenos">477</span></a>                <span class="p">)</span>  <span class="c1">#  Replace the matched content with the new content</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-478"><a href="#SelfContextClipCMT.replace_full_context_item-478"><span class="linenos">478</span></a>                <span class="c1"># print_dict({match_content: new_content})</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-479"><a href="#SelfContextClipCMT.replace_full_context_item-479"><span class="linenos">479</span></a>                <span class="k">return</span> <span class="n">success</span>
</span><span id="SelfContextClipCMT.replace_full_context_item-480"><a href="#SelfContextClipCMT.replace_full_context_item-480"><span class="linenos">480</span></a>        <span class="k">return</span> <span class="n">success</span>
</span></pre></div>


            <div class="docstring"><p>Replaces the content of a message in the full context with new content if the match content is found.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>match_content (str):</strong>  The content to search for in the full context.</li>
<li><strong>new_content (str):</strong>  The new content to replace the matched content with.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>bool: True if the replacement was successful, False otherwise.</p>
</blockquote>
</div>


                            </div>
                            <div id="SelfContextClipCMT.save_llm_output" class="classattr">
                                        <input id="SelfContextClipCMT.save_llm_output-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_llm_output</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">llm_output</span>, </span><span class="param"><span class="n">input_msg_ref</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SelfContextClipCMT.save_llm_output-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SelfContextClipCMT.save_llm_output"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SelfContextClipCMT.save_llm_output-483"><a href="#SelfContextClipCMT.save_llm_output-483"><span class="linenos">483</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">input_msg_ref</span><span class="p">):</span>
</span><span id="SelfContextClipCMT.save_llm_output-484"><a href="#SelfContextClipCMT.save_llm_output-484"><span class="linenos">484</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.save_llm_output-485"><a href="#SelfContextClipCMT.save_llm_output-485"><span class="linenos">485</span></a><span class="sd">        Saves the LLM&#39;s output, updates the grouped steps with the latest interaction, and resets the latest LLM interaction socket.</span>
</span><span id="SelfContextClipCMT.save_llm_output-486"><a href="#SelfContextClipCMT.save_llm_output-486"><span class="linenos">486</span></a>
</span><span id="SelfContextClipCMT.save_llm_output-487"><a href="#SelfContextClipCMT.save_llm_output-487"><span class="linenos">487</span></a><span class="sd">        Args:</span>
</span><span id="SelfContextClipCMT.save_llm_output-488"><a href="#SelfContextClipCMT.save_llm_output-488"><span class="linenos">488</span></a><span class="sd">            llm_output (str): The output generated by the LLM.</span>
</span><span id="SelfContextClipCMT.save_llm_output-489"><a href="#SelfContextClipCMT.save_llm_output-489"><span class="linenos">489</span></a><span class="sd">            input_msg_ref (str): The reference to the input message that triggered the LLM&#39;s response.</span>
</span><span id="SelfContextClipCMT.save_llm_output-490"><a href="#SelfContextClipCMT.save_llm_output-490"><span class="linenos">490</span></a>
</span><span id="SelfContextClipCMT.save_llm_output-491"><a href="#SelfContextClipCMT.save_llm_output-491"><span class="linenos">491</span></a><span class="sd">        Returns:</span>
</span><span id="SelfContextClipCMT.save_llm_output-492"><a href="#SelfContextClipCMT.save_llm_output-492"><span class="linenos">492</span></a><span class="sd">            None</span>
</span><span id="SelfContextClipCMT.save_llm_output-493"><a href="#SelfContextClipCMT.save_llm_output-493"><span class="linenos">493</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SelfContextClipCMT.save_llm_output-494"><a href="#SelfContextClipCMT.save_llm_output-494"><span class="linenos">494</span></a>        <span class="n">ext_msg</span> <span class="o">=</span> <span class="n">Linear_CMT</span><span class="o">.</span><span class="n">save_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">input_msg_ref</span><span class="p">)</span>  <span class="c1">#  Save the LLM output and get the extended message</span>
</span><span id="SelfContextClipCMT.save_llm_output-495"><a href="#SelfContextClipCMT.save_llm_output-495"><span class="linenos">495</span></a>        <span class="n">this_interaction</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">+</span> <span class="p">[</span><span class="n">ext_msg</span><span class="p">])</span>  <span class="c1">#  Create a deep copy of the latest interaction including the new message</span>
</span><span id="SelfContextClipCMT.save_llm_output-496"><a href="#SelfContextClipCMT.save_llm_output-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grouped_steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">this_interaction</span><span class="p">]</span>  <span class="c1">#  Append the new interaction to the grouped steps</span>
</span><span id="SelfContextClipCMT.save_llm_output-497"><a href="#SelfContextClipCMT.save_llm_output-497"><span class="linenos">497</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">after_save_llm_output</span><span class="p">(</span><span class="n">this_interaction</span><span class="p">)</span>  <span class="c1">#  Call the after-save hook for any additional processing</span>
</span><span id="SelfContextClipCMT.save_llm_output-498"><a href="#SelfContextClipCMT.save_llm_output-498"><span class="linenos">498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latest_llm_interaction_socket</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#  Reset the latest LLM interaction socket</span>
</span><span id="SelfContextClipCMT.save_llm_output-499"><a href="#SelfContextClipCMT.save_llm_output-499"><span class="linenos">499</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Saves the LLM's output, updates the grouped steps with the latest interaction, and resets the latest LLM interaction socket.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>llm_output (str):</strong>  The output generated by the LLM.</li>
<li><strong>input_msg_ref (str):</strong>  The reference to the input message that triggered the LLM's response.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="cmt_linear_think.html#LinearThinkCMT">agentevolver.module.context_manager.cmt_linear_think.LinearThinkCMT</a></dt>
                                <dd id="SelfContextClipCMT.config" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.config">config</a></dd>
                <dd id="SelfContextClipCMT.tokenizer" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.tokenizer">tokenizer</a></dd>
                <dd id="SelfContextClipCMT.full_context" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.full_context">full_context</a></dd>
                <dd id="SelfContextClipCMT.current_context_status" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.current_context_status">current_context_status</a></dd>
                <dd id="SelfContextClipCMT.max_seq_length" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.max_seq_length">max_seq_length</a></dd>
                <dd id="SelfContextClipCMT.max_env_output_length" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.max_env_output_length">max_env_output_length</a></dd>
                <dd id="SelfContextClipCMT.blackout_token_combo" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.blackout_token_combo">blackout_token_combo</a></dd>
                <dd id="SelfContextClipCMT.terminal_rewards_dict" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.terminal_rewards_dict">terminal_rewards_dict</a></dd>
                <dd id="SelfContextClipCMT.latest_llm_interaction_socket" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.latest_llm_interaction_socket">latest_llm_interaction_socket</a></dd>
                <dd id="SelfContextClipCMT.grouped_steps" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.grouped_steps">grouped_steps</a></dd>
                <dd id="SelfContextClipCMT.discarded" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.discarded">discarded</a></dd>
                <dd id="SelfContextClipCMT.is_terminated" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.is_terminated">is_terminated</a></dd>
                <dd id="SelfContextClipCMT.reward" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.reward">reward</a></dd>
                <dd id="SelfContextClipCMT.context_time_cost" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.context_time_cost">context_time_cost</a></dd>
                <dd id="SelfContextClipCMT.check_context_token_num_safe" class="function"><a href="cmt_linear_think.html#LinearThinkCMT.check_context_token_num_safe">check_context_token_num_safe</a></dd>
                <dd id="SelfContextClipCMT.steps" class="variable"><a href="cmt_linear_think.html#LinearThinkCMT.steps">steps</a></dd>
                <dd id="SelfContextClipCMT.generate_log" class="function"><a href="cmt_linear_think.html#LinearThinkCMT.generate_log">generate_log</a></dd>
                <dd id="SelfContextClipCMT.save_env_output" class="function"><a href="cmt_linear_think.html#LinearThinkCMT.save_env_output">save_env_output</a></dd>
                <dd id="SelfContextClipCMT.prepare_world_interaction" class="function"><a href="cmt_linear_think.html#LinearThinkCMT.prepare_world_interaction">prepare_world_interaction</a></dd>
                <dd id="SelfContextClipCMT.group_tokenize" class="function"><a href="cmt_linear_think.html#LinearThinkCMT.group_tokenize">group_tokenize</a></dd>

            </div>
            <div><dt><a href="cmt_linear.html#Linear_CMT">agentevolver.module.context_manager.cmt_linear.Linear_CMT</a></dt>
                                <dd id="SelfContextClipCMT.generated_token_cnt" class="variable"><a href="cmt_linear.html#Linear_CMT.generated_token_cnt">generated_token_cnt</a></dd>
                <dd id="SelfContextClipCMT.tag" class="variable"><a href="cmt_linear.html#Linear_CMT.tag">tag</a></dd>
                <dd id="SelfContextClipCMT.task_id" class="variable"><a href="cmt_linear.html#Linear_CMT.task_id">task_id</a></dd>
                <dd id="SelfContextClipCMT.current_batch_success_rate" class="variable"><a href="cmt_linear.html#Linear_CMT.current_batch_success_rate">current_batch_success_rate</a></dd>
                <dd id="SelfContextClipCMT.llm_output_mistakes" class="variable"><a href="cmt_linear.html#Linear_CMT.llm_output_mistakes">llm_output_mistakes</a></dd>
                <dd id="SelfContextClipCMT.prepare_previous_context" class="function"><a href="cmt_linear.html#Linear_CMT.prepare_previous_context">prepare_previous_context</a></dd>
                <dd id="SelfContextClipCMT.get_inc" class="function"><a href="cmt_linear.html#Linear_CMT.get_inc">get_inc</a></dd>
                <dd id="SelfContextClipCMT.remove_last_context" class="function"><a href="cmt_linear.html#Linear_CMT.remove_last_context">remove_last_context</a></dd>
                <dd id="SelfContextClipCMT.remove_last_non_llm_msg" class="function"><a href="cmt_linear.html#Linear_CMT.remove_last_non_llm_msg">remove_last_non_llm_msg</a></dd>
                <dd id="SelfContextClipCMT.json" class="function"><a href="cmt_linear.html#Linear_CMT.json">json</a></dd>
                <dd id="SelfContextClipCMT.influence_extra_reward" class="function"><a href="cmt_linear.html#Linear_CMT.influence_extra_reward">influence_extra_reward</a></dd>
                <dd id="SelfContextClipCMT.save_llm_output_do_not_register_full_context" class="function"><a href="cmt_linear.html#Linear_CMT.save_llm_output_do_not_register_full_context">save_llm_output_do_not_register_full_context</a></dd>
                <dd id="SelfContextClipCMT.to_role_content" class="function"><a href="cmt_linear.html#Linear_CMT.to_role_content">to_role_content</a></dd>
                <dd id="SelfContextClipCMT.filter_context_via_author" class="function"><a href="cmt_linear.html#Linear_CMT.filter_context_via_author">filter_context_via_author</a></dd>
                <dd id="SelfContextClipCMT.filter_context_via_authors" class="function"><a href="cmt_linear.html#Linear_CMT.filter_context_via_authors">filter_context_via_authors</a></dd>
                <dd id="SelfContextClipCMT.group_render_token_log" class="function"><a href="cmt_linear.html#Linear_CMT.group_render_token_log">group_render_token_log</a></dd>
                <dd id="SelfContextClipCMT.reward_patch" class="function"><a href="cmt_linear.html#Linear_CMT.reward_patch">reward_patch</a></dd>
                <dd id="SelfContextClipCMT.compute_madness" class="function"><a href="cmt_linear.html#Linear_CMT.compute_madness">compute_madness</a></dd>
                <dd id="SelfContextClipCMT.tokenize_steps" class="function"><a href="cmt_linear.html#Linear_CMT.tokenize_steps">tokenize_steps</a></dd>

            </div>
            <div><dt><a href="../../schema/trajectory.html#Trajectory">agentevolver.schema.trajectory.Trajectory</a></dt>
                                <dd id="SelfContextClipCMT.data_id" class="variable"><a href="../../schema/trajectory.html#Trajectory.data_id">data_id</a></dd>
                <dd id="SelfContextClipCMT.rollout_id" class="variable"><a href="../../schema/trajectory.html#Trajectory.rollout_id">rollout_id</a></dd>
                <dd id="SelfContextClipCMT.query" class="variable"><a href="../../schema/trajectory.html#Trajectory.query">query</a></dd>
                <dd id="SelfContextClipCMT.metadata" class="variable"><a href="../../schema/trajectory.html#Trajectory.metadata">metadata</a></dd>
                <dd id="SelfContextClipCMT.success" class="variable"><a href="../../schema/trajectory.html#Trajectory.success">success</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>